<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ç†è²¡å¤§æ»¿è²« âš”ï¸ğŸ’</title>

<!-- æ¡Œé¢/æ‰‹æ©Ÿå¿«æ·æ–¹å¼ icon -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- å­—é«” -->
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans&display=swap" rel="stylesheet">

<style>
:root { --serenity: #92A8D1; --rose: #F7CAC9; --cream: #FFFDF9; --text: #546E7A; --pending: #F1F3F4; }
* { box-sizing: border-box; font-family: 'ZCOOL KuaiLe', 'Noto Sans', cursive; }
body, html { margin:0; padding:0; width:100%; height:100%; background: var(--cream); color: var(--text); overflow: hidden; position: fixed; transition: background 0.3s, color 0.3s; }
body.dark { background: #1A202C; color: #E5E7EB; }
.app-header { padding:45px 20px 20px; background:white; border-radius:0 0 40px 40px; box-shadow:0 5px 15px rgba(0,0,0,0.05); z-index:100; position: relative; transition: background 0.3s; }
body.dark .app-header { background:#1E293B; }
.content-container { height: calc(100vh - 180px); overflow-y: auto; padding:20px; -webkit-overflow-scrolling: touch; transition: background 0.3s; }
.card-white { background:white; padding:20px; margin-bottom:20px; border-radius:25px; box-shadow:0 5px 15px rgba(0,0,0,0.03); transition: background 0.3s; }
body.dark .card-white { background:#1E293B; }
.item-card { background:white; padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border-radius:20px; border-left:8px solid var(--serenity); transition: 0.3s, transform 0.2s, box-shadow 0.2s; cursor:pointer; }
.item-card.is-spend { border-left-color: var(--rose); }
.item-card.is-pending { background: var(--pending); border-left-style: dashed; }
.item-card:active { transform: scale(1.02); box-shadow:0 0 10px var(--serenity),0 0 20px var(--rose); }
body.dark .item-card { background:#1E293B; }
.progress-bg { background:#eee; height:18px; border-radius:10px; margin:12px 0; overflow:hidden; }
.progress-fill { background: linear-gradient(90deg, var(--serenity), var(--rose)); height:100%; width:0%; transition:0.8s; }
.footer-nav { position:fixed; bottom:0; width:100%; height:85px; background:white; display:flex; border-radius:30px 30px 0 0; box-shadow:0 -5px 15px rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); }
.footer-nav button, .nav-link { flex:1; text-align:center; padding-top:15px; color:#CFD8DC; font-size:12px; }
.nav-link.active { color: var(--serenity); font-weight:bold; }
.nav-link i { font-size:24px; display:block; margin-bottom:4px; font-style:normal; }
.add-btn { position: fixed; bottom:100px; right:25px; width:65px; height:65px; background:linear-gradient(135deg, var(--serenity), var(--rose)); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-size:35px; box-shadow:0 8px 15px rgba(146,168,209,0.4); z-index:500; }
.tag { padding:8px 12px; background:#F5F7F9; border-radius:10px; font-size:13px; color:#78909C; margin:4px; display:inline-block; transition: transform 0.2s, box-shadow 0.2s; }
.tag.sel-s { background: var(--serenity) !important; color:white !important; }
.tag.sel-p { background: var(--rose) !important; color:white !important; }
.tag:active { transform: scale(1.2); box-shadow: 0 0 10px var(--serenity), 0 0 20px var(--rose); }
button, .btn-action { border:none; border-radius:18px; font-weight:bold; color:white; font-size:16px; padding:14px; cursor:pointer; transition: transform 0.2s; }
button:active, .btn-action:active { transform: scale(1.05); }
.modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:1000; backdrop-filter: blur(5px); }
.modal-con { position:absolute; bottom:0; width:100%; background:white; border-radius:35px 35px 0 0; padding:25px; max-height:90vh; overflow-y:auto; transition: background 0.3s; }
body.dark .modal-con { background:#1E293B; }
</style>
</head>
<body>

<div class="app-header">
    <h1>ç†è²¡å¤§æ»¿è²« âš”ï¸ <span id="rate-display">1 RM = ... â‚©</span></h1>
</div>

<div class="content-container">
<!-- æŒ‘æˆ°é  -->
<div id="p-chal" class="page">
<div class="card-white" id="chal-setup">
<h3>ğŸ¯ é–‹å•Ÿä¸€å‘¨å­˜éŒ¢æŒ‘æˆ°</h3>
<input type="number" id="target-amt" placeholder="æœ¬å‘¨ç›®æ¨™ (RM)">
<div>æ¯æ—¥éœ€å­˜ï¼š<span id="daily-amt">RM 0.00</span></div>
<button class="btn-action" style="background:var(--serenity)" onclick="startChal()">æŒ‘æˆ°é–‹å§‹ âš”ï¸</button>
</div>
<div class="card-white" id="chal-active" style="display:none">
<h3>âš”ï¸ ä¸€å‘¨æŒ‘æˆ°é€²è¡Œä¸­</h3>
<div id="chal-dates" style="font-size:11px; color:#999; margin:5px 0;"></div>
<div class="progress-bg"><div id="progress-bar" class="progress-fill"></div></div>
<center><b id="progress-text">0%</b></center>
<div style="background: linear-gradient(135deg, var(--rose), #ffdfdf); padding:18px; border-radius:20px; margin-top:15px; text-align:center;">
<small>å‰©é¤˜ <span id="days-left">-</span> å¤©</small><br>
<span>ä»Šæ—¥æ‡‰å­˜ï¼š<b id="daily-amt-active">RM 0.00</b></span>
</div>
<button class="btn-action" style="background:#eee; color:#999; margin-top:20px;" onclick="cancelChal()">çµæŸæŒ‘æˆ°ä¸¦å­˜æª”</button>
</div>
<h3>ğŸ† æŒ‘æˆ°æ¦®è­½æ¦œ</h3>
<div id="chal-history-list"></div>
</div>

<!-- æ­·å²é  -->
<div id="p-home" class="page" style="display:none">
<div class="card-white">
<h3>ğŸ“Š æœˆåº¦å ±å‘Š</h3>
<div style="height:180px;"><canvas id="monthChart"></canvas></div>
<div id="month-summary" style="text-align:center; font-size:12px; margin-top:15px;"></div>
</div>
<h3>ğŸŒ» æ­·å²è¨˜éŒ„</h3>
<div>
<select id="filter-type" onchange="renderList()">
<option value="all">å…¨éƒ¨</option>
<option value="save">å„²è“„</option>
<option value="spend">æ”¯å‡º</option>
</select>
</div>
<div id="list-render"></div>
</div>

<!-- è¨­ç½®é  -->
<div id="p-set" class="page" style="display:none">
<div class="card-white">
<h3>ğŸ“¤ å°å‡ºå ±è¡¨</h3>
<select id="export-month-sel"></select>
<button class="btn-action" style="background:#81C784" onclick="doExport()">å°å‡º Excel ğŸ“Š</button>
<hr>
<button class="btn-action" style="background:#B0BEC5" onclick="document.getElementById('f-in').click()">å°å…¥ Excel æ¢å¾©</button>
<input type="file" id="f-in" style="display:none" onchange="doImport(this)">
<button class="btn-action" style="background:var(--rose); margin-top:40px;" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
</div>
</div>
</div>

<div class="add-btn" onclick="openAdd()">+</div>

<div class="footer-nav">
<div class="nav-link active" onclick="navTo('chal', this)"><i>ğŸ†</i>æŒ‘æˆ°</div>
<div class="nav-link" onclick="navTo('home', this)"><i>ğŸŒ»</i>è¨˜éŒ„</div>
<div class="nav-link" onclick="navTo('set', this)"><i>âš™ï¸</i>è¨­ç½®</div>
</div>

<div class="modal" id="modal-add">
<div class="modal-con">
<div style="display:flex; gap:10px; margin-bottom:15px;">
<button id="ts" class="btn-action" style="background:var(--serenity); flex:1" onclick="setT('save')">å„²è“„</button>
<button id="tp" class="btn-action" style="background:#eee; color:#999; flex:1" onclick="setT('spend')">æ”¯å‡º</button>
</div>
<input type="date" id="f-date">
<small>é …ç›®é¡åˆ¥</small><div id="bx-tag"></div>
<small>å„²å­˜è³¬æˆ¶</small><div id="bx-acc"></div>
<div id="row-spend" style="display:none">
<small>ç¶²è³¼ç‹€æ…‹</small><div id="bx-order"></div>
<small>è³¼è²·ä¾†æº</small><input type="text" id="f-source" placeholder="ä¾‹å¦‚: Weverse / æ·˜å¯¶">
<div style="display:flex; gap:8px;">
<input type="number" id="f-krw" placeholder="è¼¸å…¥éŸ“å…ƒ â‚©" style="flex:1">
<button onclick="convertKrw()" style="padding:10px; border-radius:12px; border:none; background:#eee; font-size:12px; cursor:pointer;">â” RM</button>
</div>
</div>
<small>é‡‘é¡ (RM)</small><input type="number" id="f-amt" step="0.01">
<small>å‚™è¨»</small><input type="text" id="f-note" placeholder="å‚™è¨»æˆ–å•†å“åç¨±">
<button class="btn-action" style="background:var(--serenity)" onclick="saveRec()">ä¿å­˜è¨˜éŒ„ ğŸ›¡ï¸</button>
<button id="btn-del" class="btn-action" style="background:#EF5350; display:none" onclick="delRec()">ğŸ—‘ï¸ åˆªé™¤æ­¤æ¢è¨˜éŒ„</button>
<center><button onclick="closeAdd()" style="border:none;background:none;color:#999;padding:20px;">å–æ¶ˆ</button></center>
</div>
</div>

<script>
// ---- å®Œæ•´ JS ----
let db = JSON.parse(localStorage.getItem('dk_final_ultimate'))||{list:[],challenge:null,chalHistory:[]};
const CFG={acc:['RHB','HLB','TNG'],save:['âš”ï¸ ç¢©ç‰å­˜éŒ¢','ğŸ§§ æ„å¤–æ”¶å…¥','ğŸ’° å·¥è³‡'],spend:['ğŸ’¿ å°ˆè¼¯','âœ¨ å°å¡','ğŸ­ éŸ³æ¨‚åŠ‡','ğŸ›ï¸ åŒæ¬¾','ğŸ“¦ éƒµè²»','ğŸ± é£¯éŒ¢'],order:['âŒ æœªä»˜','âœ… å·²ä»˜','ğŸšš é‹é€ä¸­','ğŸ“¦ å·²æ”¶']};
let curT='save', curTag='', curAcc='RHB', curOrder='âœ… å·²ä»˜', editIdx=-1, liveRate=310, myChart=null;

// åŒ¯ç‡
fetch('https://api.exchangerate-api.com/v4/latest/MYR').then(r=>r.json()).then(d=>{ liveRate=d.rates.KRW; document.getElementById('rate-display').innerText=`1 RM = ${liveRate.toFixed(0)} â‚©`; });

// --- åŸºæœ¬å‡½æ•¸ ---
function navTo(p,el){document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));el.classList.add('active');document.querySelectorAll('.page').forEach(pg=>pg.style.display='none');document.getElementById('p-'+p).style.display='block';}
function openAdd(){document.getElementById('modal-add').style.display='block';populateTags();populateAcc();populateOrder();}
function closeAdd(){document.getElementById('modal-add').style.display='none';resetModal();}
function setT(t){curT=t;if(t=='save'){document.getElementById('row-spend').style.display='none';document.getElementById('ts').style.background='var(--serenity)';document.getElementById('tp').style.background='#eee';document.getElementById('tp').style.color='#999';}else{document.getElementById('row-spend').style.display='block';document.getElementById('tp').style.background='var(--rose)';document.getElementById('ts').style.background='#eee';document.getElementById('ts').style.color='#999';}}
function populateTags(){let bx=document.getElementById('bx-tag');bx.innerHTML='';let arr=curT=='save'?CFG.save:CFG.spend;arr.forEach(t=>{let tg=document.createElement('div');tg.className='tag';tg.innerText=t;tg.onclick=()=>{curTag=t;Array.from(bx.children).forEach(c=>c.classList.remove('sel-s','sel-p'));tg.classList.add(curT=='save'?'sel-s':'sel-p');};bx.appendChild(tg);});}
function populateAcc(){let bx=document.getElementById('bx-acc');bx.innerHTML='';CFG.acc.forEach(a=>{let tg=document.createElement('div');tg.className='tag';tg.innerText=a;tg.onclick=()=>{curAcc=a;Array.from(bx.children).forEach(c=>c.classList.remove('sel-s','sel-p'));tg.classList.add('sel-s');};bx.appendChild(tg);});}
function populateOrder(){let bx=document.getElementById('bx-order');bx.innerHTML='';CFG.order.forEach(o=>{let tg=document.createElement('div');tg.className='tag';tg.innerText=o;tg.onclick=()=>{curOrder=o;Array.from(bx.children).forEach(c=>c.classList.remove('sel-p'));tg.classList.add('sel-p');};bx.appendChild(tg);});}
function resetModal(){document.getElementById('f-date').value='';document.getElementById('f-amt').value='';document.getElementById('f-note').value='';document.getElementById('btn-del').style.display='none';curTag='';editIdx=-1;}
function saveRec(){let v={date:document.getElementById('f-date').value,amt:parseFloat(document.getElementById('f-amt').value)||0,note:document.getElementById('f-note').value,type:curT,tag:curTag,acc:curAcc,order:curOrder};if(editIdx>=0){db.list[editIdx]=v;}else{db.list.push(v);}save();closeAdd();renderList();renderChalHistory();}
function delRec(){if(editIdx>=0){db.list.splice(editIdx,1);save();closeAdd();renderList();renderChalHistory();}}
function save(){localStorage.setItem('dk_final_ultimate',JSON.stringify(db));populateMonthExport();}
function renderList(){let sel=document.getElementById('filter-type').value;let html='';db.list.forEach((v,i)=>{if(sel!='all'&&v.type!=sel)return;html+=`<div class="item-card ${v.type=='spend'?'is-spend':''}" onclick="editRec(${i})"><div>${v.date} ${v.tag} RM${v.amt.toFixed(2)}</div><div>${v.type}</div></div>`;});document.getElementById('list-render').innerHTML=html;initChart();}
function editRec(i){editIdx=i;let v=db.list[i];curT=v.type;setT(curT);curTag=v.tag;curAcc=v.acc;curOrder=v.order;document.getElementById('f-date').value=v.date;document.getElementById('f-amt').value=v.amt;document.getElementById('f-note').value=v.note;document.getElementById('btn-del').style.display='block';openAdd();}
function convertKrw(){let krw=parseFloat(document.getElementById('f-krw').value)||0;document.getElementById('f-amt').value=(krw/liveRate).toFixed(2);}
function startChal(){let amt=parseFloat(document.getElementById('target-amt').value)||0;if(!amt){alert('è«‹è¼¸å…¥ç›®æ¨™');return;}let today=new Date();db.challenge={target:amt,start:today.getTime(),end:today.getTime()+6*24*60*60*1000};updateChalUI();save();}
function cancelChal(){if(db.challenge){db.chalHistory.push({...db.challenge,actual:getWeekSaved()});db.challenge=null;updateChalUI();save();}}
function updateChalUI(){if(db.challenge){document.getElementById('chal-setup').style.display='none';document.getElementById('chal-active').style.display='block';let d=new Date(db.challenge.start);let d2=new Date(db.challenge.end);document.getElementById('chal-dates').innerText=`${d.toLocaleDateString()} ~ ${d2.toLocaleDateString()}`;let saved=getWeekSaved();let p=Math.min(100,(saved/db.challenge.target)*100);document.getElementById('progress-bar').style.width=p+'%';document.getElementById('progress-text').innerText=p.toFixed(1)+'%';document.getElementById('daily-amt').innerText='RM '+(db.challenge.target/7).toFixed(2);document.getElementById('daily-amt-active').innerText='RM '+(db.challenge.target/7).toFixed(2);document.getElementById('days-left').innerText=Math.max(0,Math.ceil((db.challenge.end-Date.now())/(24*3600*1000)));}else{document.getElementById('chal-setup').style.display='block';document.getElementById('chal-active').style.display='none';}renderChalHistory();}
function getWeekSaved(){return db.list.filter(v=>new Date(v.date).getTime()>=db.challenge.start).reduce((a,b)=>a+b.amt,0);}
function renderChalHistory(){let html='';db.chalHistory.forEach(v=>{html+=`<div class="item-card">${new Date(v.start).toLocaleDateString()} ~ ${new Date(v.end).toLocaleDateString()} RM ${v.actual.toFixed(2)} / ${v.target}</div>`;});document.getElementById('chal-history-list').innerHTML=html;}
function populateMonthExport(){let sel=document.getElementById('export-month-sel');sel.innerHTML='';let months=[...new Set(db.list.map(v=>v.date.slice(0,7)))];months.forEach(m=>{let o=document.createElement('option');o.value=m;o.innerText=m;sel.appendChild(o);});}
function doExport(){let month=document.getElementById('export-month-sel').value;let arr=db.list.filter(v=>v.date.startsWith(month));let ws=XLSX.utils.json_to_sheet(arr);let wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Sheet1');XLSX.writeFile(wb,'DKç†è²¡å ±è¡¨_'+month+'.xlsx');}
function doImport(f){let reader=new FileReader();reader.onload=e=>{let data=new Uint8Array(e.target.result);let wb=XLSX.read(data,{type:'array'});let arr=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);db.list=arr;save();renderList();};reader.readAsArrayBuffer(f.files[0]);}
function clearAll(){if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')){db={list:[],challenge:null,chalHistory:[]};save();renderList();updateChalUI();}}
function initChart(){if(myChart)myChart.destroy();let ctx=document.getElementById('monthChart');let labels=[...new Set(db.list.map(v=>v.date))];let data=labels.map(d=>db.list.filter(v=>v.date==d).reduce((a,b)=>a+(b.type=='save'?b.amt:-b.amt),0));myChart=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'æ·¨å„²è“„ RM',data:data,backgroundColor:data.map(v=>v>=0?varS('--serenity'):varS('--rose'))}]}});}
function varS(n){return getComputedStyle(document.documentElement).getPropertyValue(n);}
renderList();updateChalUI();populateMonthExport();
</script>
</body>
</html>
