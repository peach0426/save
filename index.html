<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¿½æ˜Ÿè´¦æœ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --rose: #F7CAC9; --serenity: #92A8D1; --bg: #F8FAFD; --text: #333C4E; --sub: #8E9AAF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨åŒ¯ç‡ */
        .app-header { padding: 45px 20px 10px; display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { font-size: 22px; margin: 0; color: var(--serenity); font-weight: 700; }
        .live-rate { font-size: 11px; background: white; padding: 6px 12px; border-radius: 20px; color: var(--serenity); font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* æŒ‘æˆ°é€²åº¦å¡ç‰‡ */
        .summary-card { margin: 15px 20px; padding: 25px; border-radius: 30px; background: linear-gradient(135deg, var(--serenity) 0%, var(--rose) 100%); color: white; box-shadow: 0 12px 28px rgba(146, 168, 209, 0.35); text-align: center; }
        .big-amt { font-size: 34px; font-weight: 700; margin: 8px 0; display: block; }
        .bar-bg { height: 12px; background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .bar-fill { height: 100%; background: white; width: 0%; transition: 1s ease; }

        /* æœˆåº¦åˆ†æå ±è¡¨ */
        .report-section { margin: 5px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .report-box { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); text-align: center; }
        .report-box small { font-size: 10px; color: var(--sub); display: block; margin-bottom: 2px; }
        .report-box b { font-size: 16px; color: var(--text); }

        /* Excel æ“ä½œå€ */
        .excel-ops { padding: 10px 20px; display: flex; gap: 10px; }
        .btn-excel { flex: 1; padding: 12px; border-radius: 15px; border: 1.5px solid var(--serenity); background: white; color: var(--serenity); font-weight: 700; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* æ¸…å–®å€åŸŸ */
        .list-container { flex: 1; padding: 10px 20px 240px; }
        .item-card { background: white; border-radius: 22px; padding: 18px; margin-bottom: 12px; display: flex; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        /* åº•éƒ¨å°è¦½ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px 20px 35px; border-radius: 35px 35px 0 0; box-shadow: 0 -10px 30px rgba(0,0,0,0.08); z-index: 1000; }
        .mode-tabs { display: flex; gap: 10px; }
        .tab-btn { flex: 1; padding: 16px; border-radius: 20px; border: none; background: #F1F5F9; color: var(--sub); font-weight: 700; font-size: 15px; }
        .tab-btn.active { background: var(--serenity); color: white; }

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab { position: fixed; bottom: 135px; right: 25px; width: 68px; height: 68px; background: linear-gradient(135deg, var(--rose), var(--serenity)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 35px; box-shadow: 0 10px 25px rgba(146, 168, 209, 0.4); z-index: 1001; }

        /* å¿«é€Ÿè²¼ç¤ºæ¨™ç±¤ */
        .tip-tags { display: flex; flex-wrap: wrap; gap: 8px; margin: 5px 0 15px; }
        .tag-tip { padding: 8px 14px; background: #F1F5F9; border-radius: 12px; font-size: 13px; color: var(--serenity); font-weight: 700; }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(10px); }
        .modal-content { position: absolute; bottom: 0; width: 100%; background: white; border-radius: 35px 35px 0 0; padding: 35px 25px 50px; }
        input, select, textarea { width: 100%; padding: 16px; margin-bottom: 12px; border: 2px solid #F1F5F9; border-radius: 15px; font-size: 16px; outline: none; }
        .save-btn { width: 100%; padding: 18px; background: var(--serenity); color: white; border: none; border-radius: 18px; font-weight: 700; font-size: 17px; }
    </style>
</head>
<body>

<div class="app-header">
    <h1>SVT SAVER ğŸ’</h1>
    <div class="live-rate" id="rate-display">è¼‰å…¥åŒ¯ç‡ä¸­...</div>
</div>

<div class="summary-card">
    <small id="challenge-title">2026 å„²è“„æŒ‘æˆ° (ç›®æ¨™ RM 5000)</small>
    <span class="big-amt" id="total-saved">RM 0.00</span>
    <div class="bar-bg"><div class="bar-fill" id="bar-fill"></div></div>
    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700;">
        <span id="target-text">é€²åº¦: 0%</span>
        <span>ç›®æ¨™ RM 5,000</span>
    </div>
</div>

<div class="report-section">
    <div class="report-box"><small>æœ¬æœˆå„²è“„</small><b id="month-save">RM 0</b></div>
    <div class="report-box"><small>æœ¬æœˆæ”¯å‡º</small><b id="month-spend">RM 0</b></div>
</div>

<div class="excel-ops">
    <button class="btn-excel" onclick="exportExcel()">ğŸ“¤ åŒ¯å‡º Excel</button>
    <button class="btn-excel" onclick="document.getElementById('file-in').click()">ğŸ“¥ åŒ¯å…¥ Excel</button>
    <input type="file" id="file-in" style="display:none" onchange="importExcel(this)">
</div>

<div class="list-container" id="list"></div>

<div class="fab" onclick="openModal()">+</div>

<div class="bottom-nav">
    <div class="mode-tabs">
        <button class="tab-btn active" id="tab-save" onclick="setMode('å„²è“„')">ğŸ’° å„²è“„æ¸…å–®</button>
        <button class="tab-btn" id="tab-spend" onclick="setMode('æ”¯å‡º')">ğŸ›ï¸ æ”¯å‡ºæ¸…å–®</button>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0;">è¨˜å¸³ ğŸ’</h3>
        <input type="date" id="in-date">
        
        <select id="in-tag"></select>
        
        <div style="font-size:12px; color:#AAA; margin-bottom:5px; font-weight:700;">å¿«é€Ÿè²¼ç¤º (é»æ“Šå¡«å…¥å‚™è¨»)ï¼š</div>
        <div class="tip-tags" id="tip-container"></div>
        
        <input type="number" id="in-rm" placeholder="é‡‘é¡ RM">
        <textarea id="in-note" placeholder="å‚™è¨»..." rows="2"></textarea>
        
        <button class="save-btn" onclick="save()">ç¢ºèªä¿å­˜</button>
        <button onclick="closeModal()" style="width:100%; border:none; background:none; color:#AAA; margin-top:15px;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // --- ã€è‡ªç”±ç®¡ç†å€åŸŸã€‘ ---
    // ä½ å¯ä»¥åœ¨é€™è£¡è‡ªç”±å¢åŠ æˆ–ä¿®æ”¹æ¨™ç±¤
    let db = JSON.parse(localStorage.getItem('svt_2026_final')) || {
        list: [], 
        rate: 310, 
        currentMode: 'å„²è“„',
        // å„²è“„æ¨¡å¼çš„å¤§åˆ†é¡æ¨™ç±¤
        tagsSave: ['ğŸ¦ éŠ€è¡Œå­˜å…¥', 'ğŸ“± TNG è½‰å…¥', 'ğŸ’µ ç¾é‡‘å„²è“„', 'ğŸ§§ ç´…åŒ…/çé‡‘'],
        // æ”¯å‡ºæ¨¡å¼çš„å¤§åˆ†é¡æ¨™ç±¤
        tagsSpend: ['ğŸ›ï¸ å®˜ç¶²å‘¨é‚Š', 'ğŸ’¿ å°ˆè¼¯ä»£è³¼', 'âœ¨ å°å¡äº¤æ˜“', 'âœˆï¸ åœ‹éš›éƒµè²»', 'ğŸ± ç”Ÿæ´»æ”¯å‡º'],
        // å¿«é€Ÿå‚™è¨»è²¼ç¤º (é»äº†ç›´æ¥é€²å‚™è¨»)
        tipsSave: ['å·¥è³‡', 'å…¼è·æ”¶å…¥', 'ç”Ÿæ—¥ç´…åŒ…', 'å®šæœŸå­˜æ¬¾'],
        tipsSpend: ['ç‰å¥å°å¡', 'æ·¨æ¼¢å‘¨é‚Š', 'FMLå°ˆè¼¯', 'æ—¥æœ¬ä»£è³¼']
    };

    async function fetchRate() {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/MYR');
            const data = await res.json();
            db.rate = data.rates.KRW;
            document.getElementById('rate-display').innerText = `1 RM = ${db.rate.toFixed(2)} â‚©`;
        } catch(e) { document.getElementById('rate-display').innerText = `1 RM = ${db.rate} â‚© (é›¢ç·š)`; }
        render();
    }

    function setMode(m) {
        db.currentMode = m;
        render();
    }

    function render() {
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.getElementById('tab-save').className = db.currentMode === 'å„²è“„' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-spend').className = db.currentMode === 'æ”¯å‡º' ? 'tab-btn active' : 'tab-btn';
        
        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7);

        // åŠŸèƒ½ 1ï¼šè¨ˆç®—ç¸½é€²åº¦ (æŒ‘æˆ°é‚„åœ¨)
        const totalSaved = db.list.filter(i=>i.mode==='å„²è“„').reduce((a,b)=>a+b.amt, 0);
        document.getElementById('total-saved').innerText = `RM ${totalSaved.toFixed(2)}`;
        const prog = Math.min((totalSaved/5000)*100, 100);
        document.getElementById('bar-fill').style.width = prog + '%';
        document.getElementById('target-text').innerText = `é€²åº¦: ${prog.toFixed(1)}%`;

        // åŠŸèƒ½ 2ï¼šè¨ˆç®—æœˆåº¦å ±è¡¨ (å ±è¡¨é‚„åœ¨)
        const mSave = db.list.filter(i=>i.mode==='å„²è“„' && i.date.startsWith(monthStr)).reduce((a,b)=>a+b.amt, 0);
        const mSpend = db.list.filter(i=>i.mode==='æ”¯å‡º' && i.date.startsWith(monthStr)).reduce((a,b)=>a+b.amt, 0);
        document.getElementById('month-save').innerText = `RM ${mSave.toFixed(0)}`;
        document.getElementById('month-spend').innerText = `RM ${mSpend.toFixed(0)}`;

        // åŠŸèƒ½ 3ï¼šæ¸²æŸ“æ¸…å–® (KRW æ›ç®—é‚„åœ¨)
        const filtered = db.list.filter(i => i.mode === db.currentMode);
        document.getElementById('list').innerHTML = filtered.map((i, idx) => `
            <div class="item-card" onclick="deleteItem(${db.list.indexOf(i)})">
                <div style="flex:1">
                    <small style="color:#AAA; font-weight:700;">${i.date} â€¢ ${i.tag}</small>
                    <div style="font-weight:700; margin-top:4px; font-size:16px;">${i.note}</div>
                </div>
                <div style="text-align:right">
                    <b style="color:${i.mode==='å„²è“„'?'#333':'#FF6B6B'}; font-size:17px;">RM ${i.amt.toFixed(2)}</b>
                    <div style="font-size:10px; color:#AAA;">â‚© ${(i.amt * db.rate).toFixed(0)}</div>
                </div>
            </div>
        `).join('');
        localStorage.setItem('svt_2026_final', JSON.stringify(db));
    }

    function openModal() {
        document.getElementById('modal').style.display = 'block';
        document.getElementById('in-date').valueAsDate = new Date();
        
        // åŠŸèƒ½ 4ï¼šé€™è£¡å‹•æ…‹è¼‰å…¥ä½ å¯ä»¥è‡ªç”±ä¿®æ”¹çš„æ¨™ç±¤
        const tags = db.currentMode === 'å„²è“„' ? db.tagsSave : db.tagsSpend;
        document.getElementById('in-tag').innerHTML = tags.map(t=>`<option value="${t}">${t}</option>`).join('');
        
        // åŠŸèƒ½ 5ï¼šå¿«é€Ÿå‚™è¨»è²¼ç¤ºé‚„åœ¨
        const tips = db.currentMode === 'å„²è“„' ? db.tipsSave : db.tipsSpend;
        document.getElementById('tip-container').innerHTML = tips.map(t=>`<div class="tag-tip" onclick="addTip('${t}')">${t}</div>`).join('');
    }

    function addTip(t) {
        const note = document.getElementById('in-note');
        note.value = note.value ? note.value + ', ' + t : t;
    }

    function save() {
        const amt = parseFloat(document.getElementById('in-rm').value);
        const note = document.getElementById('in-note').value;
        const date = document.getElementById('in-date').value;
        if(!amt || !note) return alert("è«‹å¡«å¯«é‡‘é¡èˆ‡å‚™è¨»");
        db.list.unshift({ date, mode: db.currentMode, amt, tag: document.getElementById('in-tag').value, note });
        render(); closeModal();
        document.getElementById('in-rm').value = ''; document.getElementById('in-note').value = '';
    }

    // åŠŸèƒ½ 6ï¼šExcel åŒ¯å‡ºåŒ¯å…¥ (ä¿è­‰é‚„åœ¨)
    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(db.list);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, `SVT_Saver_Backup.xlsx`);
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            if(confirm(`ç¢ºèªåŒ¯å…¥ï¼Ÿ`)) { db.list = [...rows, ...db.list]; render(); }
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function deleteItem(idx) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.list.splice(idx, 1); render(); } }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    window.onload = () => fetchRate();
</script>
</body>
</html>
