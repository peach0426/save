<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¿½æ˜Ÿè´¦æœ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --dk-blue: #5D9CEC; --dk-pink: #F7CAC9; --bg: #F0F4F8; --card: #FFFFFF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; }
        body { margin: 0; background: var(--bg); color: #333; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* é ‚éƒ¨å€åŸŸ */
        .top-bar { padding: 50px 20px 20px; background: white; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .top-bar h1 { font-size: 20px; margin: 0; color: var(--dk-blue); letter-spacing: 1px; }

        /* ä¸»å…§å®¹å®¹å™¨ */
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ¨£å¼ */
        .card { background: var(--card); border-radius: 25px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.03); }
        .gradient-card { background: linear-gradient(135deg, var(--dk-blue), var(--dk-pink)); color: white; border-radius: 30px; padding: 25px; position: relative; }

        /* åº•éƒ¨å°è¦½åˆ— */
        .nav-bar { height: 85px; background: white; display: flex; justify-content: space-around; align-items: center; border-radius: 30px 30px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); padding-bottom: 20px; }
        .nav-item { text-align: center; color: #BDC3C7; transition: 0.3s; font-size: 10px; font-weight: 700; }
        .nav-item.active { color: var(--dk-blue); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }

        /* æŒ‘æˆ°è¨ˆç®—å™¨ */
        .calc-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-top: 15px; font-size: 13px; border: 1px dashed rgba(255,255,255,0.5); }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #F0F0F0; }
        .list-item:last-child { border: none; }

        /* æµ®å‹•æŒ‰éˆ• */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background: var(--dk-blue); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 8px 20px rgba(93, 156, 236, 0.4); z-index: 99; }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; backdrop-filter: blur(8px); }
        .modal-body { position: absolute; bottom: 0; width: 100%; background: white; border-radius: 35px 35px 0 0; padding: 30px 20px 45px; }
        input, select { width: 100%; padding: 16px; margin-bottom: 15px; border: 2px solid #F0F4F8; border-radius: 15px; font-size: 16px; outline: none; }
        .btn-main { width: 100%; padding: 18px; background: var(--dk-blue); color: white; border: none; border-radius: 18px; font-weight: 700; font-size: 16px; }

        .tag-pill { display: inline-block; padding: 8px 15px; background: #F0F4F8; border-radius: 12px; font-size: 12px; margin: 0 5px 10px 0; color: #5D9CEC; font-weight: 700; }
    </style>
</head>
<body>

<div class="top-bar">
    <h1 id="page-title">DK CHALLENGE</h1>
    <div style="font-size:11px; color:#AAA; margin-top:5px;" id="live-rate">1 RM = --- â‚©</div>
</div>

<div class="content-area">
    <div id="page-home" class="page active">
        <div id="challenge-display"></div>
        <div class="card" style="text-align: center;">
            <p style="font-size: 14px; color: #7F8C8D;">æœ¬æœˆçµ±è¨ˆå ±å‘Š</p>
            <div style="display: flex; justify-content: space-around;">
                <div><small>ç¸½å„²è“„</small><br><b id="m-save" style="color:var(--dk-blue)">RM 0</b></div>
                <div><small>ç¸½æ”¯å‡º</small><br><b id="m-spend" style="color:var(--dk-pink)">RM 0</b></div>
            </div>
        </div>
    </div>

    <div id="page-list" class="page">
        <div class="card" style="padding: 10px;">
            <div id="main-list"></div>
        </div>
    </div>

    <div id="page-settings" class="page">
        <div class="card">
            <h3>ğŸ“‚ æ•¸æ“šç®¡ç†</h3>
            <button class="btn-main" onclick="exportExcel()" style="background:#2ecc71; margin-bottom:10px;">ğŸ“¤ åŒ¯å‡º Excel å‚™ä»½</button>
            <button class="btn-main" onclick="document.getElementById('file-in').click()" style="background:#95a5a6;">ğŸ“¥ åŒ¯å…¥æ­·å²è¨˜éŒ„</button>
            <input type="file" id="file-in" style="display:none" onchange="importExcel(this)">
        </div>
        <div class="card">
            <h3>âš”ï¸ DK æ‡‰æ´å°æ’‡æ­¥</h3>
            <p style="font-size:13px; color:#7F8C8D;">å­˜ä¸‹ä¾†çš„éŒ¢ï¼Œéƒ½æ˜¯ç‚ºäº†èˆ‡ç¢©ç‰æ›´å¥½çš„ç›¸é‡ï¼Fighting!</p>
        </div>
    </div>
</div>

<div class="fab" onclick="showAddModal()">+</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="switchPage('home', 'DK CHALLENGE', this)">
        <span class="nav-icon">âš”ï¸</span>é¦–é 
    </div>
    <div class="nav-item" onclick="switchPage('list', 'SAVING LIST', this)">
        <span class="nav-icon">ğŸ“œ</span>æ˜ç´°
    </div>
    <div class="nav-item" onclick="switchPage('settings', 'REPORT', this)">
        <span class="nav-icon">ğŸ“Š</span>å ±å‘Š
    </div>
</div>

<div class="modal" id="modal-start">
    <div class="modal-body">
        <h3>âš”ï¸ é–‹å•Ÿä¸€é€±æŒ‘æˆ°</h3>
        <input type="number" id="target-rm" placeholder="ä¸€é€±ç›®æ¨™å­˜å¤šå°‘ï¼Ÿ(RM)" oninput="updateCalc()">
        <div class="calc-box" id="calc-hint">è¼¸å…¥é‡‘é¡ï¼Œè‡ªå‹•è¨ˆç®—æ¯æ—¥ç›®æ¨™</div>
        <button class="btn-main" onclick="confirmStart()">é–‹å§‹ Fighting!</button>
        <button onclick="closeModals()" style="width:100%; border:none; background:none; margin-top:15px; color:#AAA;">å…ˆä¸è¦</button>
    </div>
</div>

<div class="modal" id="modal-record">
    <div class="modal-body">
        <h3>æ–°å¢æ¶ˆè²»/å„²è“„ ğŸ’</h3>
        <div id="tag-container"></div>
        <input type="number" id="rec-amt" placeholder="é‡‘é¡ RM">
        <input type="text" id="rec-note" placeholder="å‚™è¨» (ä¾‹å¦‚: DKåŒæ¬¾æ‰‹éŠ)">
        <button class="btn-main" onclick="saveRecord()">ä¿å­˜è¨˜éŒ„</button>
        <button onclick="closeModals()" style="width:100%; border:none; background:none; margin-top:15px; color:#AAA;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('dk_pro_v2')) || {
        list: [], challenge: null, rate: 310
    };

    const tags = {
        save: ['âš”ï¸ ç¢©ç‰å­˜éŒ¢', 'ğŸ¥¯ é£¯éŒ¢çœä¸‹', 'ğŸ§§ æ„å¤–çå‹µ'],
        spend: ['ğŸ­ éŸ³æ¨‚åŠ‡', 'ğŸ›ï¸ DKåŒæ¬¾', 'ğŸ’¿ BSSå°ˆè¼¯', 'âœ¨ å°å¡é›†è³‡', 'ğŸ“¦ éƒµè²»']
    };

    function switchPage(id, title, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        document.getElementById('page-title').innerText = title;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    }

    function render() {
        // æ¸²æŸ“æŒ‘æˆ°å¡
        const home = document.getElementById('challenge-display');
        if(!db.challenge) {
            home.innerHTML = `<div class="gradient-card" onclick="showStartModal()" style="text-align:center; background: #BDC3C7;">
                <h3>å°šæœªé–‹å§‹æŒ‘æˆ°</h3><p>é»æ“Šé€™è£¡ï¼Œç‚º DK å­˜ä¸‹ç¬¬ä¸€ç­†éŒ¢ï¼</p>
            </div>`;
        } else {
            const saved = db.list.filter(i => i.type === 'save' && new Date(i.date) >= new Date(db.challenge.start)).reduce((a,b)=>a+b.amt, 0);
            const progress = Math.min((saved / db.challenge.target) * 100, 100);
            home.innerHTML = `<div class="gradient-card">
                <span style="position:absolute; top:15px; right:20px;" onclick="cancelChallenge()">âœ•</span>
                <small>ä¸€é€±æŒ‘æˆ°é€²åº¦</small>
                <h2 style="font-size:32px; margin:10px 0;">RM ${saved.toFixed(2)}</h2>
                <div style="height:8px; background:rgba(255,255,255,0.3); border-radius:10px; margin-bottom:10px;">
                    <div style="width:${progress}%; height:100%; background:white; border-radius:10px;"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:12px;">
                    <span>ç›®æ¨™: RM ${db.challenge.target}</span>
                    <span> Fighting!</span>
                </div>
            </div>`;
        }

        // æ¸²æŸ“æœˆå ±èˆ‡æ¸…å–®
        const month = new Date().toISOString().slice(0, 7);
        const mSave = db.list.filter(i => i.type==='save' && i.date.startsWith(month)).reduce((a,b)=>a+b.amt, 0);
        const mSpend = db.list.filter(i => i.type==='spend' && i.date.startsWith(month)).reduce((a,b)=>a+b.amt, 0);
        document.getElementById('m-save').innerText = 'RM ' + mSave.toFixed(2);
        document.getElementById('m-spend').innerText = 'RM ' + mSpend.toFixed(2);

        document.getElementById('main-list').innerHTML = db.list.map((i, idx) => `
            <div class="list-item" onclick="deleteItem(${idx})">
                <div><small style="color:#AAA">${i.date}</small><br><b>${i.note}</b></div>
                <div style="text-align:right">
                    <b style="color:${i.type==='save'?'#2ecc71':'#e74c3c'}">RM ${i.amt.toFixed(2)}</b><br>
                    <small>â‚© ${(i.amt * db.rate).toFixed(0)}</small>
                </div>
            </div>
        `).join('');

        localStorage.setItem('dk_pro_v2', JSON.stringify(db));
    }

    // æŒ‘æˆ°é‚è¼¯
    function updateCalc() {
        const val = document.getElementById('target-rm').value;
        document.getElementById('calc-hint').innerText = val > 0 ? `æ¯å¤©éœ€å­˜ï¼šRM ${(val/7).toFixed(2)}` : 'è¼¸å…¥é‡‘é¡ï¼Œè‡ªå‹•è¨ˆç®—æ¯æ—¥ç›®æ¨™';
    }
    function showStartModal() { document.getElementById('modal-start').style.display = 'block'; }
    function confirmStart() {
        const target = document.getElementById('target-rm').value;
        if(!target) return;
        db.challenge = { target: parseFloat(target), start: new Date().getTime() };
        closeModals(); render();
    }
    function cancelChallenge() { if(confirm("ç¢ºå®šå–æ¶ˆæŒ‘æˆ°å—ï¼Ÿ")) { db.challenge = null; render(); } }

    // è¨˜å¸³é‚è¼¯
    let selectedTag = '', selectedType = 'save';
    function showAddModal() {
        document.getElementById('modal-record').style.display = 'block';
        const html = tags.save.map(t => `<span class="tag-pill" onclick="pickTag('${t}', 'save', this)">${t}</span>`).join('') +
                     tags.spend.map(t => `<span class="tag-pill" style="color:var(--dk-pink)" onclick="pickTag('${t}', 'spend', this)">${t}</span>`).join('');
        document.getElementById('tag-container').innerHTML = html;
    }
    function pickTag(t, type, el) {
        document.querySelectorAll('.tag-pill').forEach(p => p.style.background = '#F0F4F8');
        el.style.background = '#D1E8FF';
        selectedTag = t; selectedType = type;
    }
    function saveRecord() {
        const amt = parseFloat(document.getElementById('rec-amt').value);
        const note = document.getElementById('rec-note').value;
        if(!amt || !selectedTag) return alert("è«‹å¡«å¯«é‡‘é¡ä¸¦é¸æ“‡æ¨™ç±¤");
        db.list.unshift({ date: new Date().toISOString().slice(0,10), amt, note, tag: selectedTag, type: selectedType });
        closeModals(); render();
        document.getElementById('rec-amt').value = ''; document.getElementById('rec-note').value = '';
    }

    // ç³»çµ±åŠŸèƒ½
    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(db.list);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "SVT_Data");
        XLSX.writeFile(wb, "DK_Saver_Backup.xlsx");
    }
    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = e => {
            db.list = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).Sheets["SVT_Data"]);
            render();
        };
        reader.readAsArrayBuffer(input.files[0]);
    }
    function deleteItem(idx) { if(confirm("åˆªé™¤é€™ç­†å—ï¼Ÿ")) { db.list.splice(idx,1); render(); } }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    // åˆå§‹åŒ–åŒ¯ç‡
    fetch('https://api.exchangerate-api.com/v4/latest/MYR').then(r=>r.json()).then(d=>{
        db.rate = d.rates.KRW;
        document.getElementById('live-rate').innerText = `1 RM = ${db.rate.toFixed(1)} â‚© (DK å¯¦æ™‚åŒ¯ç‡)`;
        render();
    }).catch(()=>render());
</script>
</body>
</html>
