<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¿½æ˜Ÿç†è²¡å¤§æ»¿è²« âš”ï¸ğŸ’</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        :root { --serenity: #92A8D1; --rose: #F7CAC9; --cream: #FFFDF9; --text: #546E7A; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'ZCOOL KuaiLe', 'Ma Shan Zheng', cursive, sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--cream); color: var(--text); overflow: hidden; position: fixed; }
        
        /* æ¨™é¡Œèˆ‡åŒ¯ç‡ - ç¸®å°é«˜åº¦é©é…æ‰‹æ©Ÿ */
        .app-header { padding: 45px 20px 20px; background: white; border-radius: 0 0 50px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); z-index: 100; position: relative; }
        .app-header h1 { font-size: 24px; margin: 0; color: var(--serenity); display: flex; align-items: center; justify-content: space-between; }
        #rate-display { font-size: 12px; opacity: 0.8; margin-top: 5px; }

        /* ä¸»å…§å®¹æ»¾å‹•å€ */
        .content-container { height: calc(100vh - 190px); overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        
        /* å¡ç‰‡è¨­è¨ˆ - å»æ–¹æ ¼åŒ–ä½†ä¿æŒæ•´é½Š */
        .card-white { background: white; padding: 20px; margin-bottom: 20px; border-radius: 35px 15px 40px 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .item-card { 
            background: white; padding: 18px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            border-radius: 25px 10px 30px 10px; border-left: 10px solid var(--serenity); box-shadow: 2px 4px 10px rgba(0,0,0,0.02);
        }
        .item-card.is-spend { border-left-color: var(--rose); }

        /* æŒ‘æˆ°é€²åº¦æ¢ */
        .progress-bg { background: #ECEFF1; height: 20px; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, var(--serenity), var(--rose)); height: 100%; width: 0%; transition: 0.5s; }

        /* åº•éƒ¨å°èˆª - é‡å° iPhone åº•éƒ¨å„ªåŒ– */
        .footer-nav { 
            position: fixed; bottom: 0; width: 100%; height: 95px; 
            background: white; display: flex; align-items: center; justify-content: space-around;
            border-radius: 35px 35px 0 0; box-shadow: 0 -8px 25px rgba(0,0,0,0.06); z-index: 500;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-link { flex: 1; text-align: center; color: #CFD8DC; font-size: 13px; text-decoration: none; }
        .nav-link.active { color: var(--serenity); font-weight: bold; }
        .nav-link i { font-size: 28px; display: block; margin-bottom: 3px; font-style: normal; }

        /* æ‡¸æµ®æ–°å¢éˆ• */
        .add-btn { 
            position: fixed; bottom: 110px; right: 25px; width: 70px; height: 70px; 
            background: linear-gradient(135deg, var(--serenity), var(--rose)); 
            border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; 
            font-size: 40px; z-index: 600; box-shadow: 0 8px 20px rgba(247, 202, 201, 0.5);
        }
        
        /* å½ˆçª—å„ªåŒ–ï¼šæ‰‹æ©Ÿéµç›¤å½ˆå‡ºæ™‚ä¸å´©æ½° */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-con { 
            position: absolute; bottom: 0; width: 100%; background: white; 
            border-radius: 40px 40px 0 0; padding: 30px 25px; 
            max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        
        /* æ¨™ç±¤æ©«å‘æ»‘å‹•é˜²æ­¢æ“æ“  */
        .tag-row { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
        .tag { padding: 8px 16px; background: #F5F7F9; border-radius: 15px; font-size: 13px; color: #78909C; }
        .tag.selected-save { background: var(--serenity) !important; color: white !important; }
        .tag.selected-spend { background: var(--rose) !important; color: white !important; }

        input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 15px; background: #F5F9FF; border: 1.5px solid #ECEFF1; font-size: 16px; outline: none; }
        .btn-action { width: 100%; padding: 18px; border: none; border-radius: 20px; font-weight: bold; color: white; font-size: 16px; margin-bottom: 10px; }
        .status-label { font-size: 11px; background: #E1F5FE; color: #0288D1; padding: 2px 8px; border-radius: 5px; margin-top: 4px; display: inline-block; }
    </style>
</head>
<body>

<div class="app-header">
    <h1>DK è¿½æ˜Ÿç†è²¡ âš”ï¸ <span id="rate-display">åŒ¯ç‡åŠ è¼‰ä¸­...</span></h1>
</div>

<div class="content-container" id="main-scroll">
    <div id="p-home" class="page active">
        <div class="card-white" style="display:flex; justify-content:space-around; text-align:center; padding:15px;">
            <div><small>ğŸ’ å„²è“„</small><br><b id="mo-save" style="color:var(--serenity); font-size:20px;">RM 0</b></div>
            <div style="width:1px; background:#eee;"></div>
            <div><small>ğŸŒ¸ æ”¯å‡º</small><br><b id="mo-spend" style="color:var(--rose); font-size:20px;">RM 0</b></div>
        </div>
        <div id="list-render"></div>
    </div>
    
    <div id="p-chal" class="page" style="display:none">
        <div class="card-white">
            <h3 style="margin-top:0">ğŸ¯ å­˜éŒ¢æŒ‘æˆ°</h3>
            <small>è¨­å®šæœˆç›®æ¨™é‡‘é¡ (RM)</small>
            <input type="number" id="chal-input" placeholder="0.00" oninput="setGoal()">
            <div class="progress-bg"><div id="progress-bar" class="progress-fill"></div></div>
            <center><b id="chal-status">é€²åº¦ï¼š0%</b></center>
        </div>
    </div>

    <div id="p-report" class="page" style="display:none">
        <div class="card-white" style="text-align:center;">
            <canvas id="dkChart" style="max-height: 200px;"></canvas>
            <div id="report-details" style="margin-top:15px; font-size:15px;"></div>
        </div>
    </div>

    <div id="p-set" class="page" style="display:none">
        <div class="card-white">
            <button class="btn-action" style="background:#81C784" onclick="doExport()">ğŸ“¤ å°å‡º Excel å‚™ä»½</button>
            <button class="btn-action" style="background:#B0BEC5" onclick="document.getElementById('f-in').click()">ğŸ“¥ å°å…¥æ•¸æ“š</button>
            <input type="file" id="f-in" style="display:none" onchange="doImport(this)">
            <button class="btn-action" style="background:var(--rose); margin-top:30px;" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“š</button>
        </div>
    </div>
</div>

<div class="add-btn" onclick="openAdd()">+</div>

<div class="footer-nav">
    <div class="nav-link active" onclick="navTo('home', this)"><i>ğŸŒ»</i>æ¸…å–®</div>
    <div class="nav-link" onclick="navTo('chal', this)"><i>ğŸ†</i>æŒ‘æˆ°</div>
    <div class="nav-link" onclick="navTo('report', this)"><i>ğŸ•</i>å ±è¡¨</div>
    <div class="nav-link" onclick="navTo('set', this)"><i>âš™ï¸</i>è¨­å®š</div>
</div>

<div class="modal" id="modal-add">
    <div class="modal-con" id="modal-c">
        <div id="type-tabs" style="display:flex; background:#f0f0f0; border-radius:15px; padding:4px; margin-bottom:15px;">
            <button id="tab-s" style="flex:1; padding:10px; border:none; border-radius:12px; background:var(--serenity); color:white;" onclick="setType('save')">ğŸ’ å„²è“„</button>
            <button id="tab-p" style="flex:1; padding:10px; border:none; border-radius:12px; background:none; color:#999;" onclick="setType('spend')">ğŸŒ¸ æ”¯å‡º</button>
        </div>
        
        <small>ğŸ“… æ—¥æœŸ</small><input type="date" id="fd-date">
        <small>ğŸ¦ å¸³æˆ¶</small><div id="bx-acc" class="tag-row"></div>
        <small>ğŸ’ åˆ†é¡</small><div id="bx-tag" class="tag-row"></div>
        
        <div id="row-spend-extra" style="display:none">
            <small>ğŸ“¦ ç¶²è³¼ç‹€æ…‹</small><div id="bx-order" class="tag-row"></div>
            <small>ğŸ›ï¸ è³¼è²·ä¾†æº</small><input type="text" id="fd-source" placeholder="ä¾‹å¦‚: Weverse">
        </div>

        <small>ğŸ’° é‡‘é¡ (RM)</small><input type="number" id="fd-amt">
        <small>ğŸ·ï¸ å‚™è¨» / å•†å“å</small><input type="text" id="fd-note">
        
        <button id="btn-save" class="btn-action" style="background:var(--serenity)" onclick="submitRecord()">å„²å­˜ ğŸ’</button>
        <button id="btn-del" class="btn-action" style="background:#EF5350; display:none;" onclick="deleteCurrent()">ğŸ—‘ï¸ åˆªé™¤</button>
        <center><button onclick="closeAdd()" style="border:none;background:none;color:#999;padding:10px;">å–æ¶ˆé€€å‡º</button></center>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('dk_v9_perfect')) || { list: [], goal: 0 };
    const CFG = {
        acc: ['RHB', 'HLB', 'TNG'],
        save: ['âš”ï¸ ç¢©ç‰å­˜éŒ¢', 'ğŸ§§ æ„å¤–æ”¶å…¥'],
        spend: ['ğŸ­ éŸ³æ¨‚åŠ‡', 'ğŸ’¿ å°ˆè¼¯', 'âœ¨ å°å¡', 'ğŸ›ï¸ åŒæ¬¾', 'ğŸ“¦ éƒµè²»', 'ğŸ± é£¯éŒ¢'],
        order: ['âŒ æœªä»˜', 'âœ… å·²ä»˜', 'ğŸšš é‹é€ä¸­', 'ğŸ“¦ å·²æ”¶']
    };
    let curT='save', curA='RHB', curTag='', curO='âœ… å·²ä»˜', editIdx = -1, chartObj = null;

    function navTo(id, el) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById('p-' + id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(id === 'report') renderReport();
        if(id === 'chal') updateChalUI();
    }

    function setType(type) {
        curT = type;
        const mc = document.getElementById('modal-c');
        const spendExtra = document.getElementById('row-spend-extra');
        if(type==='save') {
            mc.style.borderTop = `10px solid var(--serenity)`;
            document.getElementById('tab-s').style.background = 'var(--serenity)';
            document.getElementById('tab-s').style.color = 'white';
            document.getElementById('tab-p').style.background = 'none';
            document.getElementById('tab-p').style.color = '#999';
            spendExtra.style.display = 'none';
            renderTags('bx-tag', CFG.save, 'selected-save');
        } else {
            mc.style.borderTop = `10px solid var(--rose)`;
            document.getElementById('tab-p').style.background = 'var(--rose)';
            document.getElementById('tab-p').style.color = 'white';
            document.getElementById('tab-s').style.background = 'none';
            document.getElementById('tab-s').style.color = '#999';
            spendExtra.style.display = 'block';
            renderTags('bx-tag', CFG.spend, 'selected-spend');
            renderTags('bx-order', CFG.order, 'selected-spend', 'order');
        }
        renderTags('bx-acc', CFG.acc, type==='save'?'selected-save':'selected-spend', 'acc');
    }

    function renderTags(cid, arr, cls, type) {
        document.getElementById(cid).innerHTML = arr.map(v => {
            let active = (type==='acc'? curA===v : (type==='order'? curO===v : curTag===v));
            return `<div class="tag ${active?cls:''}" onclick="selTag('${v}','${type}')">${v}</div>`;
        }).join('');
    }

    function selTag(v, type) {
        if(type==='acc') curA=v; else if(type==='order') curO=v; else curTag=v;
        setType(curT);
    }

    function openAdd() {
        editIdx = -1;
        document.getElementById('modal-add').style.display='block';
        document.getElementById('btn-del').style.display='none';
        document.getElementById('fd-date').value = new Date().toISOString().slice(0,10);
        document.getElementById('fd-amt').value = '';
        document.getElementById('fd-note').value = '';
        document.getElementById('fd-source').value = '';
        curTag = '';
        setType('save');
    }

    function openEdit(idx) {
        editIdx = idx; let item = db.list[idx];
        document.getElementById('modal-add').style.display='block';
        document.getElementById('btn-del').style.display='block';
        document.getElementById('fd-date').value = item.date;
        document.getElementById('fd-amt').value = item.amt;
        document.getElementById('fd-note').value = item.note || '';
        document.getElementById('fd-source').value = item.source || '';
        curT = item.type; curA = item.acc; curTag = item.tag; curO = item.order || 'âœ… å·²ä»˜';
        setType(curT);
    }

    function closeAdd() { document.getElementById('modal-add').style.display='none'; }

    function submitRecord() {
        const amt = parseFloat(document.getElementById('fd-amt').value);
        if(!amt || !curTag) return alert("è«‹å¡«å…¥é‡‘é¡ä¸¦é¸æ“‡åˆ†é¡ï¼");
        const rec = {
            date: document.getElementById('fd-date').value, amt, type: curT, tag: curTag, acc: curA,
            order: curT==='spend'?curO:'', note: document.getElementById('fd-note').value,
            source: curT==='spend'?document.getElementById('fd-source').value : ''
        };
        if(editIdx > -1) db.list[editIdx] = rec; else db.list.unshift(rec);
        saveData(); renderHome(); closeAdd();
    }

    function deleteCurrent() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.list.splice(editIdx,1); saveData(); renderHome(); closeAdd(); } }

    function renderHome() {
        const m = new Date().toISOString().slice(0, 7);
        const s = db.list.filter(i => i.type==='save' && i.date.startsWith(m)).reduce((a,b)=>a+b.amt, 0);
        const p = db.list.filter(i => i.type==='spend' && i.date.startsWith(m)).reduce((a,b)=>a+b.amt, 0);
        document.getElementById('mo-save').innerText = 'RM ' + s.toFixed(2);
        document.getElementById('mo-spend').innerText = 'RM ' + p.toFixed(2);
        document.getElementById('list-render').innerHTML = db.list.map((i, idx) => `
            <div class="item-card ${i.type==='spend'?'is-spend':''}" onclick="openEdit(${idx})">
                <div style="flex:1">
                    <b style="font-size:16px;">${i.note || i.tag}</b><br>
                    <small style="color:#BBB;">${i.date} | ${i.acc}</small><br>
                    ${i.order ? `<span class="status-label">${i.order}</span>` : ''}
                </div>
                <div style="text-align:right">
                    <b style="color:${i.type==='save'?'var(--serenity)':'var(--rose)'}; font-size:17px;">
                        ${i.type==='save'?'+':'-'} ${i.amt.toFixed(2)}
                    </b>
                </div>
            </div>`).join('');
    }

    function updateChalUI() {
        const m = new Date().toISOString().slice(0, 7);
        const s = db.list.filter(i => i.type==='save' && i.date.startsWith(m)).reduce((a,b)=>a+b.amt, 0);
        const perc = db.goal > 0 ? Math.min((s/db.goal)*100, 100) : 0;
        document.getElementById('progress-bar').style.width = perc + '%';
        document.getElementById('chal-status').innerText = `å·²é”æˆ RM ${s} / ${db.goal} (${perc.toFixed(1)}%)`;
        document.getElementById('chal-input').value = db.goal || '';
    }
    function setGoal() { db.goal = parseFloat(document.getElementById('chal-input').value) || 0; saveData(); updateChalUI(); }

    function renderReport() {
        const m = new Date().toISOString().slice(0, 7);
        const data = db.list.filter(x => x.date.startsWith(m));
        const s = data.filter(x => x.type==='save').reduce((a,b)=>a+b.amt, 0);
        const p = data.filter(x => x.type==='spend').reduce((a,b)=>a+b.amt, 0);
        document.getElementById('report-details').innerHTML = `<b>${m} ç¸½çµ</b><br>å­˜å…¥: RM ${s.toFixed(2)}<br>èŠ±æ‰: RM ${p.toFixed(2)}`;
        if(chartObj) chartObj.destroy();
        chartObj = new Chart(document.getElementById('dkChart'), {
            type: 'pie', data: { labels:['å„²è“„','æ”¯å‡º'], datasets:[{ data:[s,p], backgroundColor:['#92A8D1','#F7CAC9'] }] }
        });
    }

    function doExport() {
        const ws = XLSX.utils.json_to_sheet(db.list);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Records");
        XLSX.writeFile(wb, "DK_ç†è²¡å‚™ä»½.xlsx");
    }
    function doImport(f) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            db.list = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            saveData(); location.reload();
        }; reader.readAsArrayBuffer(f.files[0]);
    }
    function saveData() { localStorage.setItem('dk_v9_perfect', JSON.stringify(db)); }
    function clearAllData() { if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ•¸æ“šï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    // åˆå§‹åŒ–åŒ¯ç‡
    fetch('https://api.exchangerate-api.com/v4/latest/MYR')
        .then(r => r.json())
        .then(d => document.getElementById('rate-display').innerText = `1 RM = ${d.rates.KRW.toFixed(0)} â‚©`);

    renderHome();
</script>
</body>
</html>
