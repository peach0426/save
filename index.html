<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SVT Saver Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --rose: #F7CAC9; --serenity: #92A8D1; --bg: #F8FAFD; --text: #333C4E; --sub: #8E9AAF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; }
        
        body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨å€åŸŸ */
        .app-header { padding: 45px 20px 10px; flex-shrink: 0; }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .header-row h1 { font-size: 22px; margin: 0; color: var(--serenity); font-weight: 700; }
        .live-rate { font-size: 11px; background: white; padding: 6px 12px; border-radius: 20px; color: var(--serenity); font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* é€²åº¦å¡ç‰‡ */
        .summary-card { margin: 15px 20px; padding: 25px; border-radius: 30px; background: linear-gradient(135deg, var(--serenity) 0%, var(--rose) 100%); color: white; box-shadow: 0 12px 28px rgba(146, 168, 209, 0.35); text-align: center; }
        .big-amt { font-size: 34px; font-weight: 700; margin: 8px 0; display: block; }
        .bar-bg { height: 12px; background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .bar-fill { height: 100%; background: white; width: 0%; transition: 1s ease; }

        /* æœå°‹ */
        .search-area { padding: 0 20px 15px; }
        .search-bar { width: 100%; padding: 12px 18px; border-radius: 15px; border: none; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.04); outline: none; }

        /* æ¸…å–®å€åŸŸ (å¯æ»‘å‹•) */
        .list-container { flex: 1; padding: 0 20px 220px; }
        .item-card { background: white; border-radius: 22px; padding: 18px; margin-bottom: 12px; display: flex; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .date-label { font-size: 10px; color: #AAA; font-weight: 700; }

        /* åº•éƒ¨æŒ‰éˆ•å€ (ç¬¦åˆè¦æ±‚ï¼šæŒ‰éµåœ¨ä¸‹) */
        .bottom-controls { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px 20px 35px; border-radius: 35px 35px 0 0; box-shadow: 0 -10px 30px rgba(0,0,0,0.08); z-index: 1000; }
        .mode-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 14px; border-radius: 18px; border: none; background: #F1F5F9; color: var(--sub); font-weight: 700; font-size: 15px; }
        .tab-btn.active { background: var(--serenity); color: white; }
        .sync-btn { width: 100%; padding: 16px; border-radius: 20px; border: 2.5px solid var(--serenity); background: white; color: var(--serenity); font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab { position: fixed; bottom: 195px; right: 25px; width: 68px; height: 68px; background: linear-gradient(135deg, var(--rose), var(--serenity)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 35px; box-shadow: 0 10px 25px rgba(146, 168, 209, 0.4); z-index: 1001; }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; backdrop-filter: blur(10px); }
        .modal-content { position: absolute; bottom: 0; width: 100%; background: white; border-radius: 35px 35px 0 0; padding: 35px 25px 50px; }
        input, select, textarea { width: 100%; padding: 16px; border: 2px solid #F1F5F9; border-radius: 15px; margin-bottom: 12px; outline: none; font-size: 16px; }
        .confirm-btn { background: var(--serenity); color: white; border: none; width: 100%; padding: 18px; border-radius: 18px; font-weight: 700; font-size: 17px; }
    </style>
</head>
<body>

<div class="app-header">
    <div class="header-row">
        <h1>SVT SAVER ğŸ’</h1>
        <div class="live-rate" id="rate-display" onclick="fetchRate()">ğŸ”„ è¼‰å…¥åŒ¯ç‡</div>
    </div>
</div>

<div class="summary-card">
    <div style="font-size: 14px; opacity: 0.9;">æœ¬é€±å„²è“„é€²åº¦</div>
    <span class="big-amt" id="total-saved">RM 0.00</span>
    <div class="bar-bg"><div class="bar-fill" id="bar-fill"></div></div>
    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700;">
        <span>æŒ‘æˆ°ç›®æ¨™ 200</span>
        <span id="progress-text">RM 0 / 200</span>
    </div>
</div>

<div class="search-area">
    <input type="text" id="search-input" class="search-bar" placeholder="ğŸ” æœå°‹è¨˜éŒ„..." oninput="render()">
</div>

<div class="list-container" id="list"></div>

<div class="bottom-controls">
    <div class="mode-tabs">
        <button class="tab-btn active" id="tab-save" onclick="setMode('å„²è“„')">ğŸ’° å„²è“„æ¸…å–®</button>
        <button class="tab-btn" id="tab-spend" onclick="setMode('æ”¯å‡º')">ğŸ›ï¸ æ”¯å‡ºæ¸…å–®</button>
    </div>
    <button class="sync-btn" onclick="syncAllToSheet()"><span>â˜ï¸ åŒæ­¥è‡³ Google Sheet</span></button>
</div>

<div class="fab" onclick="openModal()">+</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3>æ–°å¢è¨˜éŒ„ ğŸ’</h3>
        <input type="date" id="in-date">
        <select id="in-tag" onchange="checkBank(this.value)"></select>
        <div id="bank-sub-group" style="display:none;"><select id="in-bank-type"><option value="HLB">ğŸ¦ Hong Leong Bank</option><option value="RHB">ğŸ¦ RHB Bank</option></select></div>
        <input type="number" id="in-rm" placeholder="é‡‘é¡ (RM)">
        <textarea id="in-note" placeholder="å‚™è¨»..." rows="2"></textarea>
        <div id="spend-status-group" style="display:none; gap:10px;">
            <select id="in-pay" style="flex:1"><option value="æœªä»˜æ¬¾">âŒ æœªä»˜æ¬¾</option><option value="å·²ä»˜æ¬¾">âœ… å·²ä»˜æ¬¾</option></select>
            <select id="in-ship" style="flex:1"><option value="æœªåˆ°è²¨">ğŸšš æœªåˆ°è²¨</option><option value="å·²åˆ°è²¨">ğŸ“¦ å·²åˆ°è²¨</option></select>
        </div>
        <button class="confirm-btn" onclick="save()">ç¢ºèªä¿å­˜</button>
        <button onclick="closeModal()" style="width:100%; border:none; background:none; color:#AAA; margin-top:15px;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwJSiq6UAkiDjHspCz0-5KqNP1nm28EsQVGzt6TPtoJxDcM-eMwdC1SbDuY3J8dGsj4RA/exec";

    let db = JSON.parse(localStorage.getItem('svt_2026_final_fix')) || {
        list: [], rate: 300, currentMode: 'å„²è“„',
        tagsSave: ['ğŸ¦ éŠ€è¡Œ', 'ğŸ“± TNG', 'ğŸ’µ ç¾é‡‘'],
        tagsSpend: ['âœ¨ å°å¡', 'ğŸµ å°ˆè¼¯', 'âœˆï¸ éƒµè²»', 'ğŸ§¸ å‘¨é‚Š']
    };

    async function fetchRate() {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/MYR');
            const data = await res.json();
            if(data.rates.KRW) { db.rate = data.rates.KRW; document.getElementById('rate-display').innerText = `1 RM = ${db.rate.toFixed(2)} â‚©`; render(); }
        } catch(e) { document.getElementById('rate-display').innerText = `1 RM = ${db.rate} â‚© (é›¢ç·š)`; }
    }

    function checkBank(v) { document.getElementById('bank-sub-group').style.display = (v === 'ğŸ¦ éŠ€è¡Œ') ? 'block' : 'none'; }
    function setMode(m) { db.currentMode = m; render(); }

    function render() {
        document.getElementById('tab-save').className = db.currentMode === 'å„²è“„' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-spend').className = db.currentMode === 'æ”¯å‡º' ? 'tab-btn active' : 'tab-btn';
        
        const search = document.getElementById('search-input').value.toLowerCase();
        const filtered = db.list.filter(i => i.mode === db.currentMode && (i.note.toLowerCase().includes(search) || i.date.includes(search)));
        
        const weekSave = db.list.filter(i => i.mode === 'å„²è“„').reduce((a,b) => a + b.amt, 0);
        document.getElementById('total-saved').innerText = `RM ${weekSave.toFixed(2)}`;
        document.getElementById('bar-fill').style.width = Math.min((weekSave/200)*100, 100) + '%';
        document.getElementById('progress-text').innerText = `RM ${weekSave.toFixed(0)} / 200`;

        document.getElementById('list').innerHTML = filtered.map((i, idx) => `
            <div class="item-card" onclick="deleteItem(${db.list.indexOf(i)})">
                <div style="flex:1">
                    <span class="date-label">${i.date}</span>
                    <div style="font-weight:700; font-size:16px;">${i.note}</div>
                    <div>
                        ${i.bankType ? `<span style="font-size:9px; color:var(--serenity); font-weight:700;">${i.bankType}</span>` : ''}
                        ${i.mode === 'æ”¯å‡º' ? `<small style="color:${i.payStatus==='æœªä»˜æ¬¾'?'#FF6B6B':'#059669'}; font-weight:700;">${i.payStatus} | ${i.shipStatus}</small>` : ''}
                    </div>
                </div>
                <div style="text-align:right">
                    <b style="color:${i.mode==='å„²è“„'?'#333':'#FF6B6B'}; font-size:17px;">RM ${i.amt.toFixed(2)}</b>
                    <div style="font-size:10px; color:#AAA;">â‚© ${(i.amt * db.rate).toFixed(0)}</div>
                </div>
            </div>
        `).join('');
        localStorage.setItem('svt_2026_final_fix', JSON.stringify(db));
    }

    function openModal() {
        document.getElementById('modal').style.display = 'block';
        document.getElementById('in-date').valueAsDate = new Date();
        const tags = db.currentMode === 'å„²è“„' ? db.tagsSave : db.tagsSpend;
        document.getElementById('in-tag').innerHTML = tags.map(t => `<option>${t}</option>`).join('');
        document.getElementById('spend-status-group').style.display = (db.currentMode === 'æ”¯å‡º') ? 'flex' : 'none';
        checkBank(document.getElementById('in-tag').value);
    }

    function save() {
        const amt = parseFloat(document.getElementById('in-rm').value);
        const note = document.getElementById('in-note').value;
        const date = document.getElementById('in-date').value;
        if(!amt || !note) return alert("è«‹å¡«å¯«é‡‘é¡èˆ‡å‚™è¨»");
        db.list.unshift({ date, mode: db.currentMode, amt, tag: document.getElementById('in-tag').value, bankType: document.getElementById('in-bank-type').value, payStatus: document.getElementById('in-pay').value, shipStatus: document.getElementById('in-ship').value, note });
        render(); closeModal();
        document.getElementById('in-rm').value = ''; document.getElementById('in-note').value = '';
    }

    async function syncAllToSheet() {
        if(db.list.length === 0) return alert("æ²’æœ‰è¨˜éŒ„");
        const btn = document.querySelector('.sync-btn');
        btn.innerText = "â³ åŒæ­¥ä¸­...";
        try {
            const latest = db.list[0];
            await fetch(SHEET_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({...latest, krw: Math.round(latest.amt * db.rate)}) });
            alert("âœ… åŒæ­¥æŒ‡ä»¤å·²ç™¼é€ï¼");
        } catch(e) { alert("âŒ åŒæ­¥å¤±æ•—"); }
        finally { btn.innerText = "â˜ï¸ åŒæ­¥è‡³ Google Sheet"; }
    }

    function deleteItem(idx) { if(confirm("ç¢ºå®šåˆªé™¤å—ï¼Ÿ")) { db.list.splice(idx, 1); render(); } }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    window.onload = () => { fetchRate(); render(); };
</script>
</body>
</html>
