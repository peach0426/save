<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ç†è²¡å¤§æ»¿è²« âš”ï¸ğŸ’</title>

<!-- æ¡Œé¢/æ‰‹æ©Ÿå¿«æ·æ–¹å¼ icon -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Excel.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- å­—é«” -->
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">

<style>
:root {
    --serenity: #92A8D1;
    --rose: #F7CAC9;
    --cream: #FFFDF9;
    --text: #546E7A;
    --pending: #F1F3F4;
    --warm: rgba(146,168,209,.4);
}
*{box-sizing:border-box;font-family:'ZCOOL KuaiLe', cursive;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body, html{width:100%;height:100%;overflow:hidden;background:var(--cream);color:var(--text);position:fixed;}
.app-header{padding:45px 20px 20px;background:white;border-radius:0 0 40px 40px;box-shadow:0 5px 15px rgba(0,0,0,0.05);position:relative;z-index:100;}
.app-header h1{font-size:18px;display:flex;justify-content:space-between;align-items:center;color:var(--serenity);}
.content-container{height:calc(100vh - 180px);overflow-y:auto;padding:20px;-webkit-overflow-scrolling:touch;}
.card-white{background:white;padding:20px;margin-bottom:20px;border-radius:25px;box-shadow:0 5px 15px rgba(0,0,0,0.03);transition:0.3s;opacity:1;}
.item-card{background:white;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-radius:20px;border-left:8px solid var(--serenity);transition:0.3s;cursor:pointer;}
.item-card.is-spend{border-left-color:var(--rose);}
.item-card.is-pending{background:var(--pending);border-left-style:dashed;}
.progress-bg{background:#eee;height:18px;border-radius:10px;margin:12px 0;overflow:hidden;}
.progress-fill{background:linear-gradient(90deg,var(--serenity),var(--rose));height:100%;width:0%;transition:0.8s;}
.footer-nav{position:fixed;bottom:0;width:100%;height:85px;background:white;display:flex;border-radius:30px 30px 0 0;box-shadow:0 -5px 15px rgba(0,0,0,0.05);padding-bottom:env(safe-area-inset-bottom);}
.nav-link{flex:1;text-align:center;padding-top:15px;color:#CFD8DC;font-size:12px;}
.nav-link.active{color:var(--serenity);font-weight:bold;}
.nav-link i{font-size:24px;display:block;margin-bottom:4px;font-style:normal;}
.add-btn{position:fixed;bottom:100px;right:25px;width:65px;height:65px;background:linear-gradient(135deg,var(--serenity),var(--rose));border-radius:50%;color:white;display:flex;align-items:center;justify-content:center;font-size:35px;box-shadow:0 8px 15px var(--warm);z-index:500;cursor:pointer;}
.tag{padding:8px 12px;background:#F5F7F9;border-radius:10px;font-size:13px;color:#78909C;margin:4px;display:inline-block;cursor:pointer;transition:0.2s;}
.tag.sel-s{background:var(--serenity)!important;color:white!important;}
.tag.sel-p{background:var(--rose)!important;color:white!important;}
input, select{width:100%;padding:14px;margin:8px 0;border-radius:15px;border:1.5px solid #F0F0F0;background:#F9FBFF;font-size:15px;outline:none;}
.btn-action{width:100%;padding:16px;border:none;border-radius:18px;font-weight:bold;color:white;font-size:16px;margin-top:10px;cursor:pointer;transition:0.3s;}
.btn-action:hover{opacity:.85;transform:translateY(-2px);}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;backdrop-filter:blur(5px);}
.modal-con{position:absolute;bottom:0;width:100%;background:white;border-radius:35px 35px 0 0;padding:25px;max-height:90vh;overflow-y:auto;}
</style>
</head>

<body>

<div class="app-header">
    <h1> è¿½æ˜Ÿç†è²¡å¤§æ»¿è²«âš”ï¸ <span id="rate-display">1 RM = ... â‚©</span></h1>
</div>

<div class="content-container">

    <!-- 1ï¸âƒ£ æŒ‘æˆ° -->
    <div id="p-chal" class="page">
        <div class="card-white" id="chal-setup">
            <h3>ğŸ¯ é–‹å•Ÿä¸€å‘¨å­˜éŒ¢æŒ‘æˆ°</h3>
            <input type="number" id="target-amt" placeholder="è¼¸å…¥æœ¬å‘¨ç›®æ¨™é‡‘é¡ (RM)">
            <button class="btn-action" style="background:var(--serenity)" onclick="startChal()">æŒ‘æˆ°é–‹å§‹ âš”ï¸</button>
        </div>
        <div class="card-white" id="chal-active" style="display:none">
            <h3>âš”ï¸ ä¸€å‘¨æŒ‘æˆ°é€²è¡Œä¸­</h3>
            <div id="chal-dates" style="font-size:11px;color:#999;margin:5px 0;"></div>
            <div class="progress-bg"><div id="progress-bar" class="progress-fill"></div></div>
            <center><b id="progress-text">0%</b></center>
            <div style="background: linear-gradient(135deg, var(--rose), #ffdfdf);padding:18px;border-radius:20px;margin-top:15px;text-align:center;">
                <small>å‰©é¤˜ <span id="days-left">-</span> å¤©</small><br>
                <span style="font-size:18px;">ä»Šæ—¥æ‡‰å­˜ï¼š<b id="daily-amt">RM 0.00</b></span>
            </div>
            <button class="btn-action" style="background:#eee;color:#999;margin-top:20px;" onclick="cancelChal()">çµæŸæŒ‘æˆ°ä¸¦å­˜æª”</button>
        </div>
        <h3 style="margin-left:5px;">ğŸ† æŒ‘æˆ°æ­·å²æ¸…å–®</h3>
        <div id="chal-history-list"></div>
    </div>

    <!-- 2ï¸âƒ£ è¨˜éŒ„ -->
    <div id="p-home" class="page" style="display:none;">
        <div class="card-white">
            <h3>ğŸ“Š æœˆåº¦å ±å‘Š</h3>
            <div style="height:180px;"><canvas id="monthChart"></canvas></div>
            <div id="month-summary" style="text-align:center;font-size:12px;margin-top:15px;"></div>
        </div>
        <h3 style="margin-left:5px;">ğŸŒ» æ­·å²è¨˜éŒ„</h3>
        <div id="list-render"></div>
    </div>

    <!-- 3ï¸âƒ£ å°å‡º -->
    <div id="p-set" class="page" style="display:none">
        <div class="card-white">
            <h3>ğŸ“¤ å°å‡ºå°ˆæ¥­å ±è¡¨</h3>
            <select id="export-month-sel"></select>
            <button class="btn-action" style="background:#81C784" onclick="doExport()">å°å‡º Excel + çµ±è¨ˆé  ğŸ“Š</button>
            <hr style="border:0;border-top:1px solid #eee;margin:30px 0;">
            <button class="btn-action" style="background:var(--rose);margin-top:10px;" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
        </div>
    </div>

</div>

<div class="add-btn" onclick="openAdd()">+</div>

<div class="footer-nav">
    <div class="nav-link active" onclick="navTo('chal', this)"><i>ğŸ†</i>æŒ‘æˆ°</div>
    <div class="nav-link" onclick="navTo('home', this)"><i>ğŸŒ»</i>è¨˜éŒ„</div>
    <div class="nav-link" onclick="navTo('set', this)"><i>âš™ï¸</i>è¨­ç½®</div>
</div>

<div class="modal" id="modal-add">
    <div class="modal-con">
        <div style="display:flex;gap:10px;margin-bottom:15px;">
            <button id="ts" class="btn-action" style="background:var(--serenity);flex:1" onclick="setT('save')">å„²è“„</button>
            <button id="tp" class="btn-action" style="background:#eee;color:#999;flex:1" onclick="setT('spend')">æ”¯å‡º</button>
        </div>
        <input type="date" id="f-date">
        <small>é …ç›®é¡åˆ¥</small><div id="bx-tag"></div>
        <small>å„²å­˜è³¬æˆ¶</small><div id="bx-acc"></div>
        <div id="row-spend" style="display:none">
            <small>ç¶²è³¼ç‹€æ…‹</small><div id="bx-order"></div>
            <small>è³¼è²·ä¾†æº</small><input type="text" id="f-source" placeholder="ä¾‹å¦‚: Weverse / æ·˜å¯¶">
            <div style="display:flex;gap:8px;">
                <input type="number" id="f-krw" placeholder="è¼¸å…¥éŸ“å…ƒ â‚©" style="flex:1">
                <button onclick="convertKrw()" style="padding:10px;border-radius:12px;border:none;background:#eee;font-size:12px;cursor:pointer;">â” RM</button>
            </div>
        </div>
        <small>é‡‘é¡ (RM)</small><input type="number" id="f-amt" step="0.01">
        <small>å‚™è¨»</small><input type="text" id="f-note" placeholder="å‚™è¨»æˆ–å•†å“åç¨±">
        <button class="btn-action" style="background:var(--serenity)" onclick="saveRec()">ä¿å­˜è¨˜éŒ„ ğŸ›¡ï¸</button>
        <button id="btn-del" class="btn-action" style="background:#EF5350; display:none" onclick="delRec()">ğŸ—‘ï¸ åˆªé™¤æ­¤æ¢è¨˜éŒ„</button>
        <center><button onclick="closeAdd()" style="border:none;background:none;color:#999;padding:20px;">å–æ¶ˆ</button></center>
    </div>
</div>

<script>
// --- æ•¸æ“šåˆå§‹åŒ– ---
let db = JSON.parse(localStorage.getItem('dk_final_ultimate')) || {list:[], challenge:null, chalHistory:[]};
const CFG = {acc:['RHB','HLB','TNG'], save:['âš”ï¸ ç¢©ç‰å­˜éŒ¢','ğŸ§§ æ„å¤–æ”¶å…¥','ğŸ’° å·¥è³‡'], spend:['ğŸ’¿ å°ˆè¼¯','âœ¨ å°å¡','ğŸ­ éŸ³æ¨‚åŠ‡','ğŸ›ï¸ åŒæ¬¾','ğŸ“¦ éƒµè²»','ğŸ± é£¯éŒ¢'], order:['âŒ æœªä»˜','âœ… å·²ä»˜','ğŸšš é‹é€ä¸­','ğŸ“¦ å·²æ”¶']};
let curT='save', curTag='', curAcc='RHB', curOrder='âœ… å·²ä»˜', editIdx=-1, liveRate=310;
let myChart=null;

// --- åˆ†é  ---
function navTo(id, el){
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    document.getElementById('p-'+id).style.display='block';
    document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
    el.classList.add('active');
    if(id==='chal'){updateChalUI(); renderChalHistory();}
    if(id==='home'){renderList(); initChart();}
    if(id==='set'){populateMonthExport();}
}

// --- ä¸€å‘¨æŒ‘æˆ° ---
function startChal(){
    const amt=parseFloat(document.getElementById('target-amt').value);
    if(!amt)return alert("è«‹è¼¸å…¥ç›®æ¨™é‡‘é¡");
    const start=new Date(), end=new Date();
    end.setDate(start.getDate()+6);
    db.challenge={target:amt,start:start.toISOString().slice(0,10),end:end.toISOString().slice(0,10)};
    save(); updateChalUI();
}
function cancelChal(){
    if(!db.challenge)return;
    const c=db.challenge;
    const saved=db.list.filter(i=>i.type==='save'&&i.date>=c.start&&i.date<=c.end).reduce((a,b)=>a+b.amt,0);
    const perc=((saved/c.target)*100).toFixed(1);
    db.chalHistory.unshift({...c,saved,perc});
    db.challenge=null; save(); updateChalUI(); renderChalHistory();
}
function updateChalUI(){
    if(!db.challenge){document.getElementById('chal-setup').style.display='block';document.getElementById('chal-active').style.display='none';return;}
    document.getElementById('chal-setup').style.display='none';
    document.getElementById('chal-active').style.display='block';
    const c=db.challenge, today=new Date(); today.setHours(0,0,0,0);
    const diff=Math.ceil((new Date(c.end)-today)/(1000*60*60*24))+1;
    const daysLeft=Math.max(0,diff);
    const saved=db.list.filter(i=>i.type==='save'&&i.date>=c.start&&i.date<=c.end).reduce((a,b)=>a+b.amt,0);
    const perc=Math.min((saved/c.target)*100,100);
    document.getElementById('chal-dates').innerText=`${c.start} ~ ${c.end}`;
    document.getElementById('progress-bar').style.width=perc+'%';
    document.getElementById('progress-text').innerText=`${perc.toFixed(1)}% (RM ${saved.toFixed(2)} / ${c.target})`;
    document.getElementById('days-left').innerText=daysLeft;
    const daily=(daysLeft>0)?(Math.max(c.target-saved,0)/daysLeft):0;
    document.getElementById('daily-amt').innerText=`RM ${daily.toFixed(2)}`;
}
function renderChalHistory(){
    const html=db.chalHistory.slice(0,5).map(h=>`<div style="background:white;padding:15px;border-radius:18px;margin-bottom:10px;font-size:12px;border-left:5px solid ${h.perc>=100?'#81C784':'#CFD8DC'};transition:0.3s;opacity:1;">
        <div style="display:flex;justify-content:space-between"><b>${h.start} ~ ${h.end}</b> <span>${h.perc}%</span></div>
        <div style="color:#999;margin-top:4px;">ç›®æ¨™: RM ${h.target} | å¯¦å­˜: RM ${h.saved}</div>
    </div>`).join('');
    document.getElementById('chal-history-list').innerHTML=html||'<center style="color:#ccc;margin-top:20px;">å°šç„¡å®Œæˆçš„æŒ‘æˆ°</center>';
}

// --- å„²è“„/æ”¯å‡º ---
function openAdd(){editIdx=-1;document.getElementById('modal-add').style.display='block';document.getElementById('btn-del').style.display='none';document.getElementById('f-date').value=new Date().toISOString().slice(0,10);document.getElementById('f-amt').value='';document.getElementById('f-krw').value='';document.getElementById('f-note').value='';document.getElementById('f-source').value='';curTag='';setT('save');}
function openEdit(idx){editIdx=idx;const i=db.list[idx];document.getElementById('modal-add').style.display='block';document.getElementById('btn-del').style.display='block';document.getElementById('f-date').value=i.date;document.getElementById('f-amt').value=i.amt;document.getElementById('f-note').value=i.note||'';document.getElementById('f-source').value=i.source||'';curT=i.type;curAcc=i.acc;curTag=i.tag;curOrder=i.order||'âœ… å·²ä»˜';setT(curT);}
function setT(t){curT=t;document.getElementById('ts').style.cssText=t==='save'?'background:var(--serenity);color:white;':'background:#eee;color:#999;';document.getElementById('tp').style.cssText=t==='spend'?'background:var(--rose);color:white;':'background:#eee;color:#999;';document.getElementById('row-spend').style.display=t==='spend'?'block':'none';renderTagsUI();}
function renderTagsUI(){
    const cls=curT==='save'?'sel-s':'sel-p';
    document.getElementById('bx-tag').innerHTML=CFG[curT].map(t=>`<div class="tag ${curTag===t?cls:''}" onclick="curTag='${t}';renderTagsUI()">${t}</div>`).join('');
    document.getElementById('bx-acc').innerHTML=CFG.acc.map(a=>`<div class="tag ${curAcc===a?cls:''}" onclick="curAcc='${a}';renderTagsUI()">${a}</div>`).join('');
    if(curT==='spend') document.getElementById('bx-order').innerHTML=CFG.order.map(o=>`<div class="tag ${curOrder===o?cls:''}" onclick="curOrder='${o}';renderTagsUI()">${o}</div>`).join('');
}
function saveRec(){const amt=parseFloat(document.getElementById('f-amt').value);if(!amt||!curTag)return alert("è«‹å®Œæ•´å¡«å¯«é …ç›®èˆ‡é‡‘é¡");const rec={type:curT,date:document.getElementById('f-date').value,tag:curTag,acc:curAcc,order:curOrder,source:document.getElementById('f-source').value,amt,note:document.getElementById('f-note').value};if(editIdx>-1){db.list[editIdx]=rec;}else{db.list.push(rec);}save();closeAdd();renderList();updateChalUI();}
function delRec(){if(editIdx>-1){db.list.splice(editIdx,1);save();closeAdd();renderList();updateChalUI();}}
function closeAdd(){document.getElementById('modal-add').style.display='none';}

// --- åˆ—è¡¨ ---
function renderList(){
    document.getElementById('list-render').innerHTML=db.list.map((i,idx)=>`<div class="item-card ${i.type==='spend'?'is-spend':''}" onclick="openEdit(${idx})"><div>${i.date} ${i.tag} (${i.acc})</div><div>RM ${i.amt.toFixed(2)}</div></div>`).join('');
}

// --- Excel å°å‡º ---
function populateMonthExport(){
    const set=document.getElementById('export-month-sel');set.innerHTML='';
    const months=[...new Set(db.list.map(i=>i.date.slice(0,7)))].sort((a,b)=>b.localeCompare(a));
    months.forEach(m=>set.innerHTML+=`<option value="${m}">${m}</option>`);
}
function doExport(){
    const sel=document.getElementById('export-month-sel').value;
    const wb=XLSX.utils.book_new();
    // æ­·å²æ˜ç´°
    const wsData=[['æ—¥æœŸ','é¡å‹','åˆ†é¡','è³¬æˆ¶','é‡‘é¡','å‚™è¨»']];
    db.list.filter(i=>i.date.startsWith(sel)).forEach(i=>wsData.push([i.date,i.type,i.tag,i.acc,i.amt,i.note]));
    const ws=XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb,ws,'æ­·å²æ˜ç´°');
    // çµ±è¨ˆé 
    const summary={æ”¶å…¥:0,æ”¯å‡º:0};db.list.filter(i=>i.date.startsWith(sel)).forEach(i=>summary[i.type==='save'?'æ”¶å…¥':'æ”¯å‡º']+=i.amt);
    const wsSum=XLSX.utils.aoa_to_sheet([['é¡å‹','é‡‘é¡'],['æ”¶å…¥',summary.æ”¶å…¥],['æ”¯å‡º',summary.æ”¯å‡º]]);
    XLSX.utils.book_append_sheet(wb,wsSum,'çµ±è¨ˆé ');
    XLSX.writeFile(wb,`DKFinance_${sel}.xlsx`);
}

// --- åœ–è¡¨ ---
function initChart(){
    const ctx=document.getElementById('monthChart').getContext('2d');
    const labels=[...new Set(db.list.map(i=>i.date))].sort();
    const data={æ”¶å…¥:[],æ”¯å‡º:[]};
    labels.forEach(d=>{const r=db.list.filter(i=>i.date===d);data.æ”¶å…¥.push(r.filter(i=>i.type==='save').reduce((a,b)=>a+b.amt,0));data.æ”¯å‡º.push(r.filter(i=>i.type==='spend').reduce((a,b)=>a+b.amt,0));});
    if(myChart)myChart.destroy();
    myChart=new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'æ”¶å…¥',data:data.æ”¶å…¥,backgroundColor:'#81C784'},{label:'æ”¯å‡º',data:data.æ”¯å‡º,backgroundColor:'#F06292'}]},options:{responsive:true,plugins:{legend:{position:'top'}}}});
    document.getElementById('month-summary').innerText=`æœ¬æœˆæ”¶å…¥ RM ${data.æ”¶å…¥.reduce((a,b)=>a+b,0).toFixed(2)} | æ”¯å‡º RM ${data.æ”¯å‡º.reduce((a,b)=>a+b,0).toFixed(2)}`;
}

// --- KRW -> RM ---
function convertKrw(){const krw=parseFloat(document.getElementById('f-krw').value);if(isNaN(krw))return;document.getElementById('f-amt').value=(krw/liveRate).toFixed(2);}

// --- æ¸…ç©º ---
function clearAll(){if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ")){db={list:[], challenge:null, chalHistory:[]};save();renderList();updateChalUI();renderChalHistory();}}

// --- æœ¬åœ°å­˜å„² ---
function save(){localStorage.setItem('dk_final_ultimate',JSON.stringify(db));}

// åˆå§‹
navTo('chal',document.querySelector('.nav-link.active'));
</script>

</body>
</html>
