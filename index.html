<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ç†è²¡å¤§æ»¿è²« âš”ï¸ğŸ’</title>

<!-- æ¡Œé¢/æ‰‹æ©Ÿå¿«æ·æ–¹å¼ icon -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">

<!-- å­—é«” -->
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
    --serenity:#92A8D1; --rose:#F7CAC9; --cream:#FFFDF9; --text:#546E7A; --pending:#F1F3F4;
    --dk-light:#FFE9E3; --dk-accent:#F6EAC2;
}
* { box-sizing:border-box; font-family:'ZCOOL KuaiLe','Noto Sans',cursive; -webkit-tap-highlight-color:transparent; }
body, html { margin:0; padding:0; width:100%; height:100%; background:var(--cream); color:var(--text); overflow:hidden; position:fixed; transition:0.3s; }
body.dark { background:#1E1E2F; color:#E0E0E0; }

.app-header { padding:45px 20px 20px; background:white; border-radius:0 0 40px 40px; box-shadow:0 5px 15px rgba(0,0,0,0.05); position:relative; z-index:100; }
.app-header h1 { font-size:18px; margin:0; color:var(--serenity); display:flex; justify-content:space-between; align-items:center; }

.content-container { height:calc(100vh - 180px); overflow-y:auto; padding:20px; -webkit-overflow-scrolling:touch; }
.card-white { background:white; padding:20px; margin-bottom:20px; border-radius:25px; box-shadow:0 5px 15px rgba(0,0,0,0.03); opacity:0; animation:fadeIn 0.5s forwards; }
@keyframes fadeIn { to { opacity:1; } }

.item-card { background:white; padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border-radius:20px; border-left:8px solid var(--serenity); transition:0.3s; cursor:pointer; }
.item-card.is-spend { border-left-color: var(--rose); }
.item-card.is-pending { background: var(--pending); border-left-style:dashed; }
.item-card:hover { transform:scale(1.02); }

.progress-bg { background:#eee; height:18px; border-radius:10px; margin:12px 0; overflow:hidden; }
.progress-fill { background:linear-gradient(90deg,var(--serenity),var(--rose)); height:100%; width:0%; transition:0.3s; }

.footer-nav { position:fixed; bottom:0; width:100%; height:85px; background:white; display:flex; border-radius:30px 30px 0 0; box-shadow:0 -5px 15px rgba(0,0,0,0.05); padding-bottom:env(safe-area-inset-bottom); }
.nav-link { flex:1; text-align:center; padding-top:15px; color:#CFD8DC; font-size:12px; cursor:pointer; }
.nav-link.active { color:var(--serenity); font-weight:bold; }
.nav-link i { font-size:24px; display:block; margin-bottom:4px; font-style:normal; }

.add-btn { position:fixed; bottom:100px; right:25px; width:65px; height:65px; background:linear-gradient(135deg,var(--serenity),var(--rose)); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-size:35px; box-shadow:0 8px 15px rgba(146,168,209,0.4); z-index:500; cursor:pointer; animation:btnBounce 1s infinite alternate; }
@keyframes btnBounce { 0%{transform:translateY(0);} 100%{transform:translateY(-5px);} }

.tag { padding:8px 12px; background:#F5F7F9; border-radius:10px; font-size:13px; color:#78909C; margin:4px; display:inline-block; cursor:pointer; }
.tag.sel-s { background:var(--serenity)!important; color:white!important; }
.tag.sel-p { background:var(--rose)!important; color:white!important; }

input, select { width:100%; padding:14px; margin:8px 0; border-radius:15px; border:1.5px solid #F0F0F0; background:#F9FBFF; font-size:15px; outline:none; transition:0.2s; }
input:focus, select:focus { border-color:var(--serenity); }

.btn-action { width:100%; padding:16px; border:none; border-radius:18px; font-weight:bold; color:white; font-size:16px; margin-top:10px; cursor:pointer; transition:0.2s; }
.btn-action:hover { transform:scale(1.03); }

.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; backdrop-filter:blur(5px); }
.modal-con { position:absolute; bottom:0; width:100%; background:white; border-radius:35px 35px 0 0; padding:25px; max-height:90vh; overflow-y:auto; }
</style>
</head>
<body>

<div class="app-header">
    <h1>DK ç†è²¡æŒ‘æˆ° âš”ï¸ <span id="rate-display">1 RM = ... â‚©</span></h1>
    <button onclick="fetchRate()" style="position:absolute;right:20px;top:15px;">åˆ·æ–°åŒ¯ç‡ ğŸ”„</button>
</div>

<div class="content-container">
    <!-- æŒ‘æˆ°é  -->
    <div id="p-chal" class="page">
        <div class="card-white" id="chal-setup">
            <h3 style="margin-top:0">ğŸ¯ é–‹å•Ÿä¸€å‘¨å­˜éŒ¢æŒ‘æˆ°</h3>
            <input type="number" id="target-amt" placeholder="è¼¸å…¥æœ¬å‘¨ç›®æ¨™é‡‘é¡ (RM)">
            <p>æ¯æ—¥å»ºè­°å­˜æ¬¾: <b id="daily-amt">RM 0.00</b></p>
            <button class="btn-action" style="background:var(--serenity)" onclick="startChal()">æŒ‘æˆ°é–‹å§‹ âš”ï¸</button>
        </div>
        <div class="card-white" id="chal-active" style="display:none">
            <h3>âš”ï¸ ä¸€å‘¨æŒ‘æˆ°é€²è¡Œä¸­</h3>
            <div id="chal-dates" style="font-size:11px;color:#999;margin:5px 0;"></div>
            <div class="progress-bg"><div id="progress-bar" class="progress-fill"></div></div>
            <center><b id="progress-text">0%</b></center>
            <div style="background: linear-gradient(135deg,var(--rose),#ffdfdf); padding:18px; border-radius:20px; margin-top:15px; text-align:center;">
                <small>å‰©é¤˜ <span id="days-left">-</span> å¤©</small><br>
            </div>
            <button class="btn-action" style="background:#81C784;margin-top:20px;" onclick="endChal(true)">çµæŸæŒ‘æˆ°ä¸¦å­˜æª”</button>
            <button class="btn-action" style="background:#EF5350;margin-top:10px;" onclick="endChal(false)">å–æ¶ˆæŒ‘æˆ°</button>
        </div>
        <h3 style="margin-left:5px;">ğŸ† æŒ‘æˆ°æ­·å²</h3>
        <div id="chal-history-list"></div>
    </div>

    <!-- è¨˜éŒ„é  -->
    <div id="p-home" class="page" style="display:none">
        <div class="card-white">
            <h3 style="margin:0 0 15px 0;">ğŸ“Š æœˆåº¦å ±å‘Š</h3>
            <div style="height:180px;"><canvas id="monthChart"></canvas></div>
            <div id="month-summary" style="text-align:center;font-size:12px;margin-top:15px;"></div>
        </div>
        <h3 style="margin-left:5px;">ğŸŒ» æ­·å²è¨˜éŒ„</h3>
        <select id="month-filter" onchange="renderList()"></select>
        <select id="type-filter" onchange="renderList()">
            <option value="all">å…¨éƒ¨</option>
            <option value="save">å„²è“„</option>
            <option value="spend">æ”¯å‡º</option>
        </select>
        <div id="list-render"></div>
    </div>

    <!-- å°å‡ºé  -->
    <div id="p-set" class="page" style="display:none">
        <div class="card-white">
            <h3>ğŸ“¤ å°å‡ºå°ˆæ¥­å ±è¡¨</h3>
            <select id="export-month-sel"></select>
            <button class="btn-action" style="background:#81C784" onclick="doExport()">å°å‡º Excel ğŸ“Š</button>
            <hr style="border:0;border-top:1px solid #eee;margin:30px 0;">
            <button class="btn-action" style="background:#B0BEC5" onclick="document.getElementById('f-in').click()">ğŸ“¥ å°å…¥æ•¸æ“š</button>
            <input type="file" id="f-in" style="display:none" onchange="doImport(this)">
            <button class="btn-action" style="background:var(--rose); margin-top:40px;" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
        </div>
    </div>
</div>

<div class="add-btn" onclick="openAdd()">+</div>

<div class="footer-nav">
    <div class="nav-link active" onclick="navTo('chal',this)"><i>ğŸ†</i>æŒ‘æˆ°</div>
    <div class="nav-link" onclick="navTo('home',this)"><i>ğŸŒ»</i>è¨˜éŒ„</div>
    <div class="nav-link" onclick="navTo('set',this)"><i>âš™ï¸</i>è¨­ç½®</div>
</div>

<div class="modal" id="modal-add">
    <div class="modal-con">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button id="ts" class="btn-action" style="flex:1" onclick="setT('save')">å„²è“„</button>
            <button id="tp" class="btn-action" style="flex:1" onclick="setT('spend')">æ”¯å‡º</button>
        </div>
        <input type="date" id="f-date">
        <small>é …ç›®é¡åˆ¥</small><div id="bx-tag"></div>
        <small>å„²å­˜è³¬æˆ¶</small><div id="bx-acc"></div>
        <div id="row-spend" style="display:none">
            <small>ç¶²è³¼ç‹€æ…‹</small><div id="bx-order"></div>
            <small>è³¼è²·ä¾†æº</small><input type="text" id="f-source" placeholder="ä¾‹å¦‚: Weverse / æ·˜å¯¶">
            <div style="display:flex; gap:8px;">
                <input type="number" id="f-krw" placeholder="è¼¸å…¥éŸ“å…ƒ â‚©" style="flex:1">
                <button onclick="convertKrw()" style="padding:10px;border-radius:12px;border:none;background:#eee;font-size:12px;cursor:pointer;">â” RM</button>
            </div>
        </div>
        <small>é‡‘é¡ (RM)</small><input type="number" id="f-amt" step="0.01">
        <small>å‚™è¨»</small><input type="text" id="f-note" placeholder="å‚™è¨»æˆ–å•†å“åç¨±">
        <button class="btn-action" style="background:var(--serenity)" onclick="saveRec()">ä¿å­˜è¨˜éŒ„ ğŸ›¡ï¸</button>
        <button id="btn-del" class="btn-action" style="background:#EF5350; display:none" onclick="delRec()">ğŸ—‘ï¸ åˆªé™¤æ­¤æ¢è¨˜éŒ„</button>
        <center><button onclick="closeAdd()" style="border:none;background:none;color:#999;padding:20px;">å–æ¶ˆ</button></center>
    </div>
</div>

<script>
let db = JSON.parse(localStorage.getItem('dk_final_ultimate')) || { list:[], challenge:null, chalHistory:[] };
const CFG = { acc:['RHB','HLB','TNG'], save:['âš”ï¸ ç¢©ç‰å­˜éŒ¢','ğŸ§§ æ„å¤–æ”¶å…¥','ğŸ’° å·¥è³‡'], spend:['ğŸ’¿ å°ˆè¼¯','âœ¨ å°å¡','ğŸ­ éŸ³æ¨‚åŠ‡','ğŸ›ï¸ åŒæ¬¾','ğŸ“¦ éƒµè²»','ğŸ± é£¯éŒ¢'], order:['âŒ æœªä»˜','âœ… å·²ä»˜','ğŸšš é‹é€ä¸­','ğŸ“¦ å·²æ”¶'] };
let curT='save', curTag='', curAcc='RHB', curOrder='âœ… å·²ä»˜', editIdx=-1, liveRate=310;
let myChart=null;

/* --- åˆ†é  --- */
function navTo(id,el){ document.querySelectorAll('.page').forEach(p=>p.style.display='none'); document.getElementById('p-'+id).style.display='block'; document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active')); el.classList.add('active'); if(id==='chal'){updateChalUI(); renderChalHistory();} if(id==='home'){renderList(); initChart();} if(id==='set') populateMonthExport();}

/* --- åŒ¯ç‡ --- */
function fetchRate(){ fetch('https://api.exchangerate-api.com/v4/latest/MYR').then(r=>r.json()).then(d=>{ liveRate=d.rates.KRW; document.getElementById('rate-display').innerText=`1 RM = ${liveRate.toFixed(0)} â‚©`; }).catch(()=>{ alert("åŒ¯ç‡ç²å–å¤±æ•—"); }); }
fetchRate();

/* --- æŒ‘æˆ° --- */
function startChal(){
    const amt=parseFloat(document.getElementById('target-amt').value);
    if(!amt) return alert("è«‹è¼¸å…¥ç›®æ¨™é‡‘é¡");
    const start=new Date(), end=new Date(); end.setDate(start.getDate()+6);
    db.challenge={target:amt, start:start.toISOString().slice(0,10), end:end.toISOString().slice(0,10)};
    save(); updateChalUI();
}
function endChal(saveFlag){
    if(!db.challenge) return;
    const c=db.challenge;
    const saved=db.list.filter(i=>i.type==='save' && i.date>=c.start && i.date<=c.end).reduce((a,b)=>a+b.amt,0);
    if(saveFlag){ const perc=((saved/c.target)*100).toFixed(1); db.chalHistory.unshift({...c,saved,perc}); }
    db.challenge=null; save(); updateChalUI(); renderChalHistory();
}
function updateChalUI(){
    if(!db.challenge){ document.getElementById('chal-setup').style.display='block'; document.getElementById('chal-active').style.display='none'; document.getElementById('daily-amt').innerText='RM 0.00'; return; }
    document.getElementById('chal-setup').style.display='none'; document.getElementById('chal-active').style.display='block';
    const c=db.challenge; const today=new Date(); today.setHours(0,0,0,0);
    const daysLeft=Math.max(0, Math.ceil((new Date(c.end)-today)/(1000*60*60*24))+1);
    const saved=db.list.filter(i=>i.type==='save' && i.date>=c.start && i.date<=c.end).reduce((a,b)=>a+b.amt,0);
    const perc=Math.min((saved/c.target)*100,100);
    document.getElementById('chal-dates').innerText=`${c.start} ~ ${c.end}`;
    document.getElementById('progress-bar').style.width=perc+'%';
    document.getElementById('progress-text').innerText=`${perc.toFixed(1)}% (RM ${saved.toFixed(2)} / ${c.target})`;
    document.getElementById('days-left').innerText=daysLeft;
    const daily=(daysLeft>0)?Math.max(c.target-saved,0)/daysLeft:0;
    document.getElementById('daily-amt').innerText=`RM ${daily.toFixed(2)}`;
}
function renderChalHistory(){
    document.getElementById('chal-history-list').innerHTML=db.chalHistory.map((h,i)=>`<div class="card-white" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><div><b>${h.start}~${h.end}</b> <br>ç›®æ¨™: RM ${h.target} | å¯¦å­˜: RM ${h.saved}</div><button onclick="db.chalHistory.splice(${i},1);save();renderChalHistory();">åˆªé™¤</button></div>`).join('')||'<center style="color:#ccc;margin-top:20px;">å°šç„¡å®Œæˆçš„æŒ‘æˆ°</center>';
}

/* --- è¨˜éŒ„ --- */
function initChart(){
    const ctx=document.getElementById('monthChart').getContext('2d');
    const monthStr=document.getElementById('month-filter')?.value||new Date().toISOString().slice(0,7);
    const filter=db.list.filter(i=>i.date.startsWith(monthStr));
    const income=filter.filter(i=>i.type==='save').reduce((a,b)=>a+b.amt,0);
    const expense=filter.filter(i=>i.type==='spend').reduce((a,b)=>a+b.amt,0);
    if(myChart) myChart.destroy();
    myChart=new Chart(ctx,{type:'pie',data:{labels:['å„²è“„','æ”¯å‡º'],datasets:[{data:[income,expense],backgroundColor:['#81C784','#EF5350']}]}, options:{responsive:true}});
    document.getElementById('month-summary').innerText=`ç¸½å„²è“„ RM ${income.toFixed(2)} | ç¸½æ”¯å‡º RM ${expense.toFixed(2)}`;
}
function renderList(){
    const m=document.getElementById('month-filter').value;
    const t=document.getElementById('type-filter').value;
    const list=db.list.filter(i=>i.date.startsWith(m)&&(t==='all'||i.type===t));
    document.getElementById('list-render').innerHTML=list.map((i,idx)=>`<div class="item-card ${i.type==='spend'?'is-spend':''}"><div>${i.date} ${i.type==='save'?'ğŸ’°':'ğŸ’³'} ${i.amt} | ${i.note||''}</div><button onclick="delIdx(${idx})">åˆªé™¤</button></div>`).join('')||'<center style="color:#ccc;">ç„¡è³‡æ–™</center>';
}
function delIdx(idx){ db.list.splice(idx,1); save(); renderList(); initChart(); }

/* --- æ·»åŠ  --- */
function openAdd(){document.getElementById('modal-add').style.display='block'; resetAdd();}
function closeAdd(){document.getElementById('modal-add').style.display='none'; editIdx=-1; document.getElementById('row-spend').style.display='none';}
function setT(t){ curT=t; document.getElementById('row-spend').style.display=(t==='spend')?'block':'none'; }
function resetAdd(){document.getElementById('f-date').valueAsDate=new Date(); document.getElementById('f-amt').value=''; document.getElementById('f-note').value=''; document.getElementById('f-krw').value=''; document.getElementById('f-source').value=''; }
function saveRec(){
    const d=document.getElementById('f-date').value, amt=parseFloat(document.getElementById('f-amt').value||0), note=document.getElementById('f-note').value, type=curT;
    if(!d || !amt) return alert("è«‹è¼¸å…¥æ—¥æœŸåŠé‡‘é¡");
    const rec={date:d,amt,type,note};
    db.list.push(rec); save(); closeAdd(); renderList(); initChart(); updateChalUI();
}
function delRec(){ if(editIdx>=0){ db.list.splice(editIdx,1); save(); renderList(); closeAdd(); updateChalUI(); } }

/* --- Excel --- */
function populateMonthExport(){
    const s=document.getElementById('export-month-sel'); s.innerHTML=''; const months=[...new Set(db.list.map(i=>i.date.slice(0,7)))]; months.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.innerText=m; s.appendChild(o); });
}
function doExport(){
    const m=document.getElementById('export-month-sel').value; const list=db.list.filter(i=>i.date.startsWith(m));
    const ws=XLSX.utils.json_to_sheet(list); 
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'å ±è¡¨'); XLSX.writeFile(wb,`DK_report_${m}.xlsx`);
}
function doImport(f){ const r=new FileReader(); r.onload=e=>{ const wb=XLSX.read(e.target.result,{type:'binary'}); const ws=wb.Sheets[wb.SheetNames[0]]; const data=XLSX.utils.sheet_to_json(ws); db.list=data; save(); renderList(); initChart(); updateChalUI(); }; r.readAsBinaryString(f.files[0]); }

/* --- å·¥å…· --- */
function save(){ localStorage.setItem('dk_final_ultimate',JSON.stringify(db)); }
function clearAll(){ if(confirm('ç¢ºå®šæ¸…ç©ºå…¨éƒ¨æ•¸æ“š?')){ db={list:[],challenge:null,chalHistory:[]}; save(); renderList(); renderChalHistory(); updateChalUI(); initChart(); } }

</script>
</body>
</html>
