<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DK è¿½æ˜Ÿç†è²¡å¤§æ»¿è²« âš”ï¸ğŸ’</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        :root { --serenity: #92A8D1; --rose: #F7CAC9; --cream: #FFFDF9; --text: #546E7A; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'ZCOOL KuaiLe', cursive; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--cream); color: var(--text); overflow: hidden; position: fixed; }
        
        .app-header { padding: 45px 20px 20px; background: white; border-radius: 0 0 40px 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); z-index: 100; position: relative; }
        .app-header h1 { font-size: 18px; margin: 0; color: var(--serenity); display: flex; align-items: center; justify-content: space-between; }
        
        .content-container { height: calc(100vh - 180px); overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        .card-white { background: white; padding: 20px; margin-bottom: 20px; border-radius: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .item-card { background: white; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 20px; border-left: 8px solid var(--serenity); box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .item-card.is-spend { border-left-color: var(--rose); }

        .daily-hint { background: linear-gradient(135deg, var(--rose), #ffdfdf); color: #6d4c41; padding: 18px; border-radius: 20px; margin-top: 15px; border: 1px solid #ffcfcf; }
        .progress-bg { background: #eee; height: 18px; border-radius: 10px; margin: 12px 0; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, var(--serenity), var(--rose)); height: 100%; width: 0%; transition: 0.8s; }

        .footer-nav { position: fixed; bottom: 0; width: 100%; height: 85px; background: white; display: flex; border-radius: 30px 30px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); }
        .nav-link { flex: 1; text-align: center; padding-top: 15px; color: #CFD8DC; font-size: 12px; }
        .nav-link.active { color: var(--serenity); font-weight: bold; }
        .nav-link i { font-size: 24px; display: block; margin-bottom: 4px; font-style: normal; }

        .add-btn { position: fixed; bottom: 100px; right: 25px; width: 65px; height: 65px; background: linear-gradient(135deg, var(--serenity), var(--rose)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 35px; box-shadow: 0 8px 15px rgba(146,168,209,0.4); z-index: 500; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-con { position: absolute; bottom: 0; width: 100%; background: white; border-radius: 35px 35px 0 0; padding: 25px; max-height: 90vh; overflow-y: auto; }
        .tag-row { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .tag { padding: 8px 15px; background: #F5F7F9; border-radius: 12px; font-size: 13px; color: #78909C; border: 1px solid transparent; }
        .tag.sel-s { background: var(--serenity) !important; color: white !important; border-color: #7d93be; }
        .tag.sel-p { background: var(--rose) !important; color: white !important; border-color: #e5b4b3; }

        input { width: 100%; padding: 14px; margin: 8px 0; border-radius: 15px; border: 1.5px solid #F0F0F0; background: #F9FBFF; font-size: 15px; outline: none; }
        .btn-action { width: 100%; padding: 16px; border: none; border-radius: 18px; font-weight: bold; color: white; font-size: 16px; margin-top: 10px; }
        .status-label { font-size: 10px; background: #E3F2FD; color: #1976D2; padding: 2px 8px; border-radius: 5px; margin-top: 4px; display: inline-block; }
    </style>
</head>
<body>

<div class="app-header">
    <h1>DK ç†è²¡æŒ‘æˆ° âš”ï¸ <span id="rate-display">1 RM = ... â‚©</span></h1>
</div>

<div class="content-container">
    <div id="p-chal" class="page">
        <div class="card-white" id="chal-setup">
            <h3 style="margin-top:0">ğŸ¯ è¨­å®šå„²è“„é€±æœŸ</h3>
            <small>ç›®æ¨™é‡‘é¡ (RM)</small>
            <input type="number" id="target-amt" placeholder="0.00">
            <small>èµ·æ­¢æ—¥æœŸ</small>
            <div style="display:flex; gap:10px;">
                <input type="date" id="start-date">
                <input type="date" id="end-date">
            </div>
            <button class="btn-action" style="background:var(--serenity)" onclick="startChal()">æŒ‘æˆ°é–‹å§‹ âš”ï¸</button>
        </div>

        <div class="card-white" id="chal-active" style="display:none">
            <h3 style="margin:0">âš”ï¸ æŒ‘æˆ°ä¸­...</h3>
            <div class="progress-bg"><div id="progress-bar" class="progress-fill"></div></div>
            <center><b id="progress-text">0%</b></center>
            <div class="daily-hint">
                <center>
                    <small>è·é›¢æŒ‘æˆ°çµæŸé‚„å‰© <span id="days-left">-</span> å¤©</small><br>
                    <span style="font-size:18px;">ä»Šæ—¥æ‡‰å­˜ï¼š<b id="daily-amt">RM 0.00</b></span>
                </center>
            </div>
            <button class="btn-action" style="background:#eee; color:#999; margin-top:20px;" onclick="cancelChal()">å–æ¶ˆä¸¦é‡æ–°è¨­å®š</button>
        </div>
    </div>

    <div id="p-home" class="page" style="display:none">
        <div id="list-render"></div>
    </div>

    <div id="p-set" class="page" style="display:none">
        <div class="card-white">
            <button class="btn-action" style="background:#81C784" onclick="doExport()">ğŸ“¤ å°å‡º Excel å‚™ä»½</button>
            <button class="btn-action" style="background:#B0BEC5; margin-top:15px;" onclick="document.getElementById('f-in').click()">ğŸ“¥ å°å…¥æ•¸æ“šå›è£œ</button>
            <input type="file" id="f-in" style="display:none" onchange="doImport(this)">
            <button class="btn-action" style="background:var(--rose); margin-top:40px;" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æœ¬åœ°ç´€éŒ„</button>
        </div>
    </div>
</div>

<div class="add-btn" onclick="openAdd()">+</div>

<div class="footer-nav">
    <div class="nav-link active" onclick="navTo('chal', this)"><i>ğŸ†</i>æŒ‘æˆ°</div>
    <div class="nav-link" onclick="navTo('home', this)"><i>ğŸŒ»</i>æ¸…å–®</div>
    <div class="nav-link" onclick="navTo('set', this)"><i>âš™ï¸</i>è¨­å®š</div>
</div>

<div class="modal" id="modal-add">
    <div class="modal-con">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button id="ts" class="btn-action" style="background:var(--serenity); flex:1" onclick="setT('save')">å„²è“„</button>
            <button id="tp" class="btn-action" style="background:#eee; color:#999; flex:1" onclick="setT('spend')">æ”¯å‡º</button>
        </div>
        <input type="date" id="f-date">
        <small>å¸³æˆ¶</small><div id="bx-acc" class="tag-row"></div>
        <small>åˆ†é¡</small><div id="bx-tag" class="tag-row"></div>
        
        <div id="row-spend" style="display:none">
            <small>ç¶²è³¼ç‹€æ…‹</small><div id="bx-order" class="tag-row"></div>
            <small>è³¼è²·ä¾†æº</small><input type="text" id="f-source" placeholder="ä¾‹å¦‚: Weverse / å®˜ç¶²">
        </div>

        <small>é‡‘é¡ (RM)</small><input type="number" id="f-amt">
        <small>å‚™è¨» / å•†å“å</small><input type="text" id="f-note">
        
        <button class="btn-action" style="background:var(--serenity)" onclick="saveRec()">å„²å­˜ç´€éŒ„ ğŸ›¡ï¸</button>
        <button id="btn-del" class="btn-action" style="background:#EF5350; display:none" onclick="delRec()">ğŸ—‘ï¸ åˆªé™¤æ­¤ç´€éŒ„</button>
        <center><button onclick="closeAdd()" style="border:none;background:none;color:#999;padding:15px;">å–æ¶ˆ</button></center>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('dk_final_v2025')) || { list: [], challenge: null };
    const CFG = {
        acc: ['RHB', 'HLB', 'TNG'],
        save: ['âš”ï¸ ç¢©ç‰å­˜éŒ¢', 'ğŸ§§ æ„å¤–æ”¶å…¥', 'ğŸ’° å·¥è³‡'],
        spend: ['ğŸ’¿ å°ˆè¼¯', 'âœ¨ å°å¡', 'ğŸ­ éŸ³æ¨‚åŠ‡', 'ğŸ›ï¸ åŒæ¬¾', 'ğŸ“¦ éƒµè²»', 'ğŸ± é£¯éŒ¢'],
        order: ['âŒ æœªä»˜', 'âœ… å·²ä»˜', 'ğŸšš é‹é€ä¸­', 'ğŸ“¦ å·²æ”¶']
    };
    let curT = 'save', curTag = '', curAcc = 'RHB', curOrder = 'âœ… å·²ä»˜', editIdx = -1;

    function navTo(id, el) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById('p-' + id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(id === 'chal') updateChalUI();
        if(id === 'home') renderList();
    }

    // --- æŒ‘æˆ°é‚è¼¯ ---
    function startChal() {
        const amt = parseFloat(document.getElementById('target-amt').value);
        const s = document.getElementById('start-date').value;
        const e = document.getElementById('end-date').value;
        if(!amt || !s || !e) return alert("è³‡è¨Šä¸å®Œæ•´ï¼");
        db.challenge = { target: amt, start: s, end: e };
        save(); updateChalUI();
    }
    function cancelChal() { if(confirm("ç¢ºå®šå–æ¶ˆæŒ‘æˆ°ï¼Ÿ")) { db.challenge = null; save(); updateChalUI(); } }
    
    function updateChalUI() {
        if(!db.challenge) {
            document.getElementById('chal-setup').style.display='block';
            document.getElementById('chal-active').style.display='none';
            return;
        }
        document.getElementById('chal-setup').style.display='none';
        document.getElementById('chal-active').style.display='block';
        const c = db.challenge;
        const today = new Date(); today.setHours(0,0,0,0);
        const endD = new Date(c.end);
        const daysLeft = Math.ceil((endD - today) / (1000*60*60*24));
        const saved = db.list.filter(i => i.type === 'save' && i.date >= c.start && i.date <= c.end).reduce((a,b)=>a+b.amt, 0);
        const perc = Math.min((saved/c.target)*100, 100);
        document.getElementById('progress-bar').style.width = perc + '%';
        document.getElementById('progress-text').innerText = `${perc.toFixed(1)}% (RM ${saved.toFixed(2)} / ${c.target})`;
        document.getElementById('days-left').innerText = Math.max(0, daysLeft);
        const daily = (daysLeft > 0) ? (Math.max(c.target - saved, 0) / daysLeft) : 0;
        document.getElementById('daily-amt').innerText = `RM ${daily.toFixed(2)}`;
    }

    // --- ç´€éŒ„é‚è¼¯ ---
    function setT(t) {
        curT = t;
        document.getElementById('ts').style.cssText = t==='save'?'background:var(--serenity);color:white;':'background:#eee;color:#999;';
        document.getElementById('tp').style.cssText = t==='spend'?'background:var(--rose);color:white;':'background:#eee;color:#999;';
        document.getElementById('row-spend').style.display = t==='spend'?'block':'none';
        renderTagsUI();
    }
    function renderTagsUI() {
        const cls = curT==='save'?'sel-s':'sel-p';
        document.getElementById('bx-acc').innerHTML = CFG.acc.map(a => `<div class="tag ${curAcc===a?cls:''}" onclick="curAcc='${a}';renderTagsUI()">${a}</div>`).join('');
        document.getElementById('bx-tag').innerHTML = CFG[curT].map(t => `<div class="tag ${curTag===t?cls:''}" onclick="curTag='${t}';renderTagsUI()">${t}</div>`).join('');
        if(curT==='spend') document.getElementById('bx-order').innerHTML = CFG.order.map(o => `<div class="tag ${curOrder===o?cls:''}" onclick="curOrder='${o}';renderTagsUI()">${o}</div>`).join('');
    }
    function openAdd() { editIdx = -1; document.getElementById('modal-add').style.display='block'; document.getElementById('btn-del').style.display='none'; document.getElementById('f-date').value=new Date().toISOString().slice(0,10); document.getElementById('f-amt').value=''; document.getElementById('f-note').value=''; curTag=''; setT('save'); }
    function openEdit(idx) {
        editIdx = idx; const i = db.list[idx];
        document.getElementById('modal-add').style.display='block';
        document.getElementById('btn-del').style.display='block';
        document.getElementById('f-date').value = i.date;
        document.getElementById('f-amt').value = i.amt;
        document.getElementById('f-note').value = i.note || '';
        document.getElementById('f-source').value = i.source || '';
        curT = i.type; curAcc = i.acc; curTag = i.tag; curOrder = i.order || 'âœ… å·²ä»˜';
        setT(curT);
    }
    function saveRec() {
        const amt = parseFloat(document.getElementById('f-amt').value);
        if(!amt || !curTag) return alert("è«‹å¡«å¯«é‡‘é¡èˆ‡åˆ†é¡ï¼");
        const data = { date: document.getElementById('f-date').value, amt, type: curT, tag: curTag, acc: curAcc, note: document.getElementById('f-note').value, order: curT==='spend'?curOrder:'', source: curT==='spend'?document.getElementById('f-source').value:'' };
        if(editIdx > -1) db.list[editIdx] = data; else db.list.unshift(data);
        save(); closeAdd(); renderList(); updateChalUI();
    }
    function delRec() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.list.splice(editIdx,1); save(); closeAdd(); renderList(); updateChalUI(); } }
    function closeAdd() { document.getElementById('modal-add').style.display='none'; }
    function renderList() {
        document.getElementById('list-render').innerHTML = db.list.map((i, idx) => `
            <div class="item-card ${i.type==='spend'?'is-spend':''}" onclick="openEdit(${idx})">
                <div style="flex:1"><b>${i.tag}</b><br><small>${i.date} | ${i.acc}</small><br>
                ${i.order?`<span class="status-label">${i.order}</span>`:''} ${i.source?`<small style="color:#999">[${i.source}]</small>`:''}</div>
                <div style="text-align:right; color:${i.type==='save'?'var(--serenity)':'var(--rose)'}"><b>${i.type==='save'?'+':'-'} RM ${i.amt.toFixed(2)}</b></div>
            </div>`).join('');
    }

    // --- å·¥å…· ---
    function save() { localStorage.setItem('dk_final_v2025', JSON.stringify(db)); }
    function doExport() { const ws = XLSX.utils.json_to_sheet(db.list); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "DK_DATA"); XLSX.writeFile(wb, "DK_Backup.xlsx"); }
    function doImport(f) { const r = new FileReader(); r.onload = (e) => { const d = new Uint8Array(e.target.result); const wb = XLSX.read(d, {type:'array'}); db.list = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); save(); location.reload(); }; r.readAsArrayBuffer(f.files[0]); }
    function clearAll() { if(confirm("ç¢ºå®šåˆªé™¤æ‰€æœ‰æœ¬åœ°ç´€éŒ„ï¼Ÿé€™ä¸å¯æ’¤éŠ·ã€‚")) { localStorage.clear(); location.reload(); } }

    fetch('https://api.exchangerate-api.com/v4/latest/MYR').then(r=>r.json()).then(d=>document.getElementById('rate-display').innerText=`1 RM = ${d.rates.KRW.toFixed(0)} â‚©`);
    document.getElementById('start-date').value = new Date().toISOString().slice(0,10);
    updateChalUI();
</script>
</body>
</html>
