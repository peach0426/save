<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¿½æ˜Ÿç†è²¡å¤§æ»¿è²« âš”ï¸ğŸ’</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --serenity: #92A8D1; --rose: #F7CAC9; --cream: #FFF9F2; --text: #5D6D7E; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--cream); color: var(--text); font-family: 'Noto Sans TC', sans-serif; overflow: hidden; }
        
        /* æ¨™é¡Œ */
        .app-header { padding: 55px 25px 20px; background: white; border-radius: 0 0 40px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 25px rgba(0,0,0,0.04); }
        .app-header h1 { font-family: 'ZCOOL KuaiLe', cursive; font-size: 22px; margin: 0; color: var(--serenity); }

        /* åˆ‡æ›é é¢ */
        .content-container { height: calc(100% - 185px); overflow-y: auto; padding: 20px; }
        .page { display: none; } .page.active { display: block; }

        /* å¡ç‰‡ */
        .card-white { background: white; border-radius: 30px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.03); margin-bottom: 15px; }
        .item-card { background: white; border-radius: 25px; padding: 18px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; border-left: 8px solid var(--serenity); }
        .item-card.spend { border-left-color: var(--rose); }

        /* å°èˆª */
        .footer-nav { position: fixed; bottom: 0; width: 100%; height: 90px; background: white; display: flex; align-items: center; border-top: 1px solid #F1F5F9; padding-bottom: 15px; border-radius: 35px 35px 0 0; }
        .nav-link { flex: 1; text-align: center; color: #D1D5DB; font-size: 11px; font-weight: 700; }
        .nav-link.active { color: var(--serenity); }
        .nav-link i { font-size: 24px; display: block; font-style: normal; margin-bottom: 2px; }

        /* å½ˆçª— & é¡è‰²åˆ‡æ› */
        .add-btn { position: fixed; bottom: 105px; right: 25px; width: 65px; height: 65px; background: linear-gradient(135deg, var(--serenity), var(--rose)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 35px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 200; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(8px); }
        .modal-con { position: absolute; bottom: 0; width: 100%; background: white; border-radius: 45px 45px 0 0; padding: 30px; max-height: 92vh; overflow-y: auto; border-top: 12px solid var(--serenity); }
        .modal-con.mode-spend { border-top-color: var(--rose); }

        /* æ¨™ç±¤ */
        .tag-row { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 20px; }
        .tag { padding: 10px 15px; background: #F3F4F6; border-radius: 12px; font-size: 12px; font-weight: 700; color: #777; }
        .tag.active-save { background: var(--serenity); color: white; }
        .tag.active-spend { background: var(--rose); color: white; }

        input { width: 100%; padding: 15px; margin-bottom: 12px; border: 2px solid #F1F5F9; border-radius: 15px; font-size: 15px; outline: none; }
        .btn-go { width: 100%; padding: 18px; border: none; border-radius: 20px; font-weight: 700; color: white; margin-top: 10px; }
        
        /* æŒ‘æˆ°é€²åº¦ */
        .day-box { background: #f8f9fa; border-radius: 12px; padding: 10px 0; text-align: center; font-size: 10px; }
        .day-box.done { background: var(--serenity); color: white; font-weight: bold; }
        
        .order-tag { font-size: 10px; background: #f0f2f5; color: #888; padding: 2px 6px; border-radius: 6px; margin-right: 4px; }
        .source-tag { font-size: 10px; background: #EBF5FB; color: var(--serenity); padding: 2px 6px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="app-header">
    <h1 id="page-title">æ¶ˆè²»æ¸…å–® ğŸ´ğŸ’</h1>
    <div id="rate-val" style="font-size: 11px; font-weight: bold; color: var(--serenity);">è¼‰å…¥åŒ¯ç‡...</div>
</div>

<div class="content-container">
    <div id="p-home" class="page active">
        <div class="card-white" style="display:flex; justify-content:space-around; text-align:center;">
            <div><small>ğŸ’ å„²è“„ç¸½é¡</small><br><b id="mo-s" style="color:var(--serenity); font-size:18px;">RM 0</b></div>
            <div><small>ğŸŒ¸ æ”¯å‡ºç¸½é¡</small><br><b id="mo-p" style="color:var(--rose); font-size:18px;">RM 0</b></div>
        </div>
        <div id="main-list"></div>
    </div>
    
    <div id="p-challenge" class="page">
        <div class="card-white" id="chal-setup">
            <h3 style="color:var(--serenity)">ğŸ¯ ä¸€å‘¨æŒ‘æˆ°è¨­å®š</h3>
            <small>æœ¬å‘¨ç›®æ¨™å­˜å¤šå°‘ (RM)ï¼Ÿ</small>
            <input type="number" id="chal-target-val" placeholder="ä¾‹å¦‚: 700">
            <p id="chal-hint" style="font-size:12px; color:#999;"></p>
            <button class="btn-go" style="background:var(--serenity)" onclick="startChal()">âš”ï¸ é–‹å§‹æŒ‘æˆ°</button>
        </div>
        <div class="card-white" id="chal-active" style="display:none">
            <h3 style="margin:0; color:var(--serenity)">ğŸ† æŒ‘æˆ°é€²è¡Œä¸­</h3>
            <div id="chal-daily-text" style="font-size:13px; margin:10px 0;"></div>
            <div style="width:100%; height:12px; background:#EEE; border-radius:10px; overflow:hidden; margin-bottom:15px;">
                <div id="chal-bar" style="height:100%; width:0%; background:var(--serenity); transition:0.5s;"></div>
            </div>
            <div id="chal-grid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; margin-bottom:20px;"></div>
            <button class="btn-go" style="background:#EEE; color:#999;" onclick="cancelChal()">å–æ¶ˆæœ¬å‘¨æŒ‘æˆ°</button>
        </div>
        <div class="card-white" style="text-align:center">
            <small>è¿½æ˜Ÿç­‰ç´š</small>
            <h2 id="rank-name" style="color:var(--serenity); margin:5px 0;">è¿½æ˜Ÿå¯¦ç¿’ç”Ÿ ğŸ¥</h2>
        </div>
    </div>

    <div id="p-report" class="page">
        <div class="card-white">
            <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:15px;">
                <button onclick="changeMonth(-1)" style="border:none;background:none;font-size:20px;">â¬…ï¸</button>
                <b id="month-label"></b>
                <button onclick="changeMonth(1)" style="border:none;background:none;font-size:20px;">â¡ï¸</button>
            </div>
            <canvas id="dkChart"></canvas>
            <div id="month-summary" style="margin-top:20px; text-align:center; line-height:2;"></div>
        </div>
    </div>

    <div id="p-set" class="page">
        <div class="card-white">
            <button class="btn-go" style="background:#A2D9CE" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½ (Excel)</button>
            <button class="btn-go" style="background:#D5D8DC; margin:15px 0" onclick="document.getElementById('f-up').click()">ğŸ“¥ åŒ¯å…¥æ•¸æ“š</button>
            <input type="file" id="f-up" style="display:none" onchange="importData(this)">
            <button class="btn-go" style="background:var(--rose)" onclick="if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')){localStorage.clear();location.reload();}">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
        </div>
    </div>
</div>

<div class="add-btn" onclick="openAdd()">+</div>

<div class="footer-nav">
    <div class="nav-link active" onclick="nav('home', 'æ¶ˆè²»æ¸…å–® ğŸ´ğŸ’', this)"><i>ğŸŒ»</i>æ¸…å–®</div>
    <div class="nav-link" onclick="nav('challenge', 'å­˜éŒ¢æŒ‘æˆ° ğŸ†', this)"><i>ğŸ†</i>æŒ‘æˆ°</div>
    <div class="nav-link" onclick="nav('report', 'æœˆåº¦å ±è¡¨ ğŸ•', this)"><i>ğŸ•</i>å ±è¡¨</div>
    <div class="nav-link" onclick="nav('set', 'æ•¸æ“šä¸­å¿ƒ âš™ï¸', this)"><i>âš™ï¸</i>è¨­å®š</div>
</div>

<div class="modal" id="mod-add">
    <div class="modal-con" id="mod-con">
        <div style="display:flex; background:#F1F5F9; border-radius:15px; padding:5px; margin-bottom:20px;">
            <button id="tab-s" style="flex:1; padding:12px; border:none; border-radius:10px; font-weight:bold; background:var(--serenity); color:white;" onclick="toggleType('save')">ğŸ’ å„²è“„</button>
            <button id="tab-p" style="flex:1; padding:12px; border:none; border-radius:10px; font-weight:bold; background:none; color:#999;" onclick="toggleType('spend')">ğŸŒ¸ æ”¯å‡º</button>
        </div>
        <small>ğŸ“… æ—¥æœŸ</small><input type="date" id="r-date">
        <small>ğŸ¦ å¸³æˆ¶</small><div id="box-acc" class="tag-row"></div>
        <small id="label-tag">ğŸ’ å„²è“„é¡åˆ¥</small><div id="box-tag" class="tag-row"></div>
        <div id="row-order" style="display:none"><small>ğŸ“¦ ç¶²è³¼ç‹€æ…‹</small><div id="box-order" class="tag-row"></div></div>
        <small>ğŸ’° é‡‘é¡ (RM)</small><input type="number" id="r-amt" placeholder="0.00">
        <small>ğŸ·ï¸ å•†å“åç¨±</small><input type="text" id="r-note" placeholder="å°ˆè¼¯/å‘¨é‚Š/é£¯éŒ¢...">
        <small>ğŸ›ï¸ è³¼è²·ä¾†æº</small><input type="text" id="r-source" placeholder="Weverse/ä»£è³¼/å¯¦é«”åº—...">
        <button id="btn-submit" class="btn-go" style="background:var(--serenity)" onclick="doSave()">ç¢ºèªè¨˜éŒ„ âš”ï¸</button>
        <center><button onclick="closeAdd()" style="border:none;background:none;color:#BBB;margin-top:15px;padding:10px;">å–æ¶ˆ</button></center>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('dk_final_v1')) || { list: [], chal: { active: false, target: 0 } };
    const config = {
        acc: ['RHB', 'HLB', 'TNG'],
        save: ['âš”ï¸ ç¢©ç‰å­˜éŒ¢', 'ğŸ§§ æ„å¤–æ”¶å…¥'],
        spend: ['ğŸ­ éŸ³æ¨‚åŠ‡', 'ğŸ’¿ å°ˆè¼¯', 'âœ¨ å°å¡', 'ğŸ›ï¸ åŒæ¬¾', 'ğŸ“¦ éƒµè²»', 'âœˆï¸ æ©Ÿé…’', 'ğŸ± é£¯éŒ¢', 'ğŸš— äº¤é€š', 'ğŸ¡ å…¶ä»–'],
        order: ['âŒ æœªä»˜æ¬¾', 'âœ… å·²ä»˜æ¬¾', 'ğŸšš æœªåˆ°è²¨', 'ğŸ“¦ å·²æ”¶è²¨']
    };
    let curType = 'save', curAcc = 'RHB', curTag = '', curOrder = 'âœ… å·²ä»˜æ¬¾', viewMonth = new Date().toISOString().slice(0, 7), myChart = null;

    function nav(id, title, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('p-' + id).classList.add('active');
        document.getElementById('page-title').innerText = title;
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(id === 'report') updateReport();
        if(id === 'challenge') updateChalUI();
    }

    function toggleType(type) {
        curType = type; curTag = '';
        const con = document.getElementById('mod-con');
        const btn = document.getElementById('btn-submit');
        const ts = document.getElementById('tab-s');
        const tp = document.getElementById('tab-p');
        if(type === 'save') {
            con.classList.remove('mode-spend'); ts.style.background = 'var(--serenity)'; ts.style.color='white'; tp.style.background='none'; tp.style.color='#999';
            btn.style.background = 'var(--serenity)'; document.getElementById('label-tag').innerText = 'ğŸ’ å„²è“„é¡åˆ¥'; document.getElementById('row-order').style.display='none';
            renderTags(config.save);
        } else {
            con.classList.add('mode-spend'); tp.style.background = 'var(--rose)'; tp.style.color='white'; ts.style.background='none'; ts.style.color='#999';
            btn.style.background = 'var(--rose)'; document.getElementById('label-tag').innerText = 'ğŸŒ¸ æ”¯å‡ºé¡åˆ¥'; document.getElementById('row-order').style.display='block';
            renderTags(config.spend);
        }
        renderAccs(); renderOrders();
    }

    function renderAccs() { document.getElementById('box-acc').innerHTML = config.acc.map(a => `<div class="tag ${curAcc===a?(curType==='save'?'active-save':'active-spend'):''}" onclick="curAcc='${a}';renderAccs()">${a}</div>`).join(''); }
    function renderTags(arr) { document.getElementById('box-tag').innerHTML = arr.map(t => `<div class="tag ${curTag===t?(curType==='save'?'active-save':'active-spend'):''}" onclick="curTag='${t}';renderTags(${curType==='save'?'config.save':'config.spend'})">${t}</div>`).join(''); }
    function renderOrders() { document.getElementById('box-order').innerHTML = config.order.map(o => `<div class="tag ${curOrder===o?'active-spend':''}" onclick="curOrder='${o}';renderOrders()">${o}</div>`).join(''); }

    function openAdd() { document.getElementById('mod-add').style.display='block'; document.getElementById('r-date').value = new Date().toISOString().slice(0, 10); toggleType('save'); }
    function closeAdd() { document.getElementById('mod-add').style.display='none'; }

    function doSave() {
        const amt = parseFloat(document.getElementById('r-amt').value);
        if(!amt || !curTag) return alert("è³‡æ–™ä¸å®Œæ•´ï¼");
        db.list.unshift({ date: document.getElementById('r-date').value, amt: amt, type: curType, tag: curTag, acc: curAcc, order: curType==='spend'?curOrder:'', note: document.getElementById('r-note').value, source: document.getElementById('r-source').value });
        saveDB(); renderHome(); closeAdd();
    }

    function renderHome() {
        const m = new Date().toISOString().slice(0, 7);
        const sS = db.list.filter(i => i.type==='save' && i.date.startsWith(m)).reduce((a,b)=>a+b.amt, 0);
        const sP = db.list.filter(i => i.type==='spend' && i.date.startsWith(m)).reduce((a,b)=>a+b.amt, 0);
        document.getElementById('mo-s').innerText = 'RM ' + sS.toFixed(2);
        document.getElementById('mo-p').innerText = 'RM ' + sP.toFixed(2);
        document.getElementById('main-list').innerHTML = db.list.map((i, idx) => `
            <div class="item-card ${i.type==='spend'?'spend':''}" onclick="del(${idx})">
                <div style="flex:1"><b>${i.note || i.tag}</b><div style="margin-top:4px;">${i.order?`<span class="order-tag">${i.order}</span>`:''}${i.source?`<span class="source-tag">${i.source}</span>`:''}<small style="color:#BBB;font-size:10px;">${i.date} | ${i.acc}</small></div></div>
                <div style="text-align:right"><b style="color:${i.type==='save'?'var(--serenity)':'var(--rose)'}">${i.type==='save'?'+':'-'} RM ${i.amt.toFixed(2)}</b></div>
            </div>`).join('');
        updateRank();
    }

    function updateRank() {
        const count = db.list.filter(i => i.type === 'save').length;
        let rank = "è¿½æ˜Ÿå¯¦ç¿’ç”Ÿ ğŸ¥";
        if(count > 10) rank = "ç¨±è·å…‹æ‹‰ ğŸ’";
        if(count > 30) rank = "DK çš„å°ˆæ¥­åŸ·äº‹ âš”ï¸";
        if(count > 50) rank = "DK çš„è¶…ç´šå¤§å‚µä¸» ğŸ‘‘";
        document.getElementById('rank-name').innerText = rank;
    }

    // æŒ‘æˆ°é‚è¼¯
    document.getElementById('chal-target-val').oninput = function() { document.getElementById('chal-hint').innerText = this.value ? `å¹³å‡æ¯å¤©è¦å­˜: RM ${(this.value/7).toFixed(2)}` : ''; };
    function startChal() {
        const v = parseFloat(document.getElementById('chal-target-val').value);
        if(!v) return;
        db.chal = { active: true, target: v, start: new Date().toISOString().slice(0, 10) };
        saveDB(); updateChalUI();
    }
    function cancelChal() { if(confirm("å–æ¶ˆé€²åº¦æœƒé‡ç½®å–”ï¼Ÿ")) { db.chal = { active: false }; saveDB(); updateChalUI(); } }
    function updateChalUI() {
        if(!db.chal.active) { document.getElementById('chal-setup').style.display='block'; document.getElementById('chal-active').style.display='none'; }
        else {
            document.getElementById('chal-setup').style.display='none'; document.getElementById('chal-active').style.display='block';
            document.getElementById('chal-daily-text').innerText = `ç›®æ¨™: RM ${db.chal.target} | æ¯å¤©éœ€å­˜: RM ${(db.chal.target/7).toFixed(2)}`;
            const now = new Date(); const sun = new Date(now.setDate(now.getDate() - (now.getDay()||7) + 1)); sun.setHours(0,0,0,0);
            let done = 0; let html = '';
            for(let i=0; i<7; i++) {
                let d = new Date(sun); d.setDate(d.getDate() + i); let dS = d.toISOString().slice(0, 10);
                let ok = db.list.some(x => x.date === dS && x.type === 'save');
                if(ok) done++;
                html += `<div class="day-box ${ok?'done':''}">${i+1}å¤©<br>${ok?'ğŸ’':'â˜ï¸'}</div>`;
            }
            document.getElementById('chal-grid').innerHTML = html;
            document.getElementById('chal-bar').style.width = (done/7*100)+'%';
        }
    }

    function updateReport() {
        document.getElementById('month-label').innerText = viewMonth;
        const mD = db.list.filter(x => x.date.startsWith(viewMonth));
        const s = mD.filter(x => x.type==='save').reduce((a,b)=>a+b.amt,0);
        const p = mD.filter(x => x.type==='spend').reduce((a,b)=>a+b.amt,0);
        document.getElementById('month-summary').innerHTML = `ğŸ’ å„²è“„: RM ${s.toFixed(2)} | ğŸŒ¸ æ”¯å‡º: RM ${p.toFixed(2)}<br><b>âœ¨ çµé¤˜: RM ${(s-p).toFixed(2)}</b>`;
        if(myChart) myChart.destroy();
        myChart = new Chart(document.getElementById('dkChart'), { type:'doughnut', data:{ labels:['å„²è“„','æ”¯å‡º'], datasets:[{data:[s,p], backgroundColor:['#92A8D1','#F7CAC9']}] } });
    }
    function changeMonth(s) { let d = new Date(viewMonth+"-01"); d.setMonth(d.getMonth()+s); viewMonth = d.toISOString().slice(0,7); updateReport(); }
    function del(idx) { if(confirm("åˆªé™¤ï¼Ÿ")) { db.list.splice(idx,1); saveDB(); renderHome(); } }
    function saveDB() { localStorage.setItem('dk_final_v1', JSON.stringify(db)); }
    function exportData() { XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(db.list), "Data"), "DK_Money.xlsx"); }
    function importData(f) { const r = new FileReader(); r.onload = e => { db.list = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets["Data"]); saveDB(); location.reload(); }; r.readAsArrayBuffer(f.files[0]); }

    renderHome();
    fetch('https://api.exchangerate-api.com/v4/latest/MYR').then(r=>r.json()).then(d=>document.getElementById('rate-val').innerText=`1 RM = ${d.rates.KRW.toFixed(0)} â‚©`);
</script>
</body>
</html>
