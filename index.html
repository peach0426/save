<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¿½æ˜Ÿç†è´¢å¤§æ»¿è²«âš”ï¸ğŸ’</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        :root { --serenity: #92A8D1; --rose: #F7CAC9; --cream: #FFFDF9; --text: #546E7A; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'ZCOOL KuaiLe', cursive; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--cream); color: var(--text); overflow: hidden; position: fixed; }
        
        /* é¡¶éƒ¨æ±‡ç‡ */
        .app-header { padding: 45px 20px 20px; background: white; border-radius: 0 0 40px 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); z-index: 100; position: relative; }
        .app-header h1 { font-size: 18px; margin: 0; color: var(--serenity); display: flex; align-items: center; justify-content: space-between; }
        
        /* é¡µé¢æ»šåŠ¨åŒºåŸŸ */
        .content-container { height: calc(100vh - 180px); overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        .card-white { background: white; padding: 20px; margin-bottom: 20px; border-radius: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        
        /* è®°å½•å¡ç‰‡ */
        .item-card { background: white; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 20px; border-left: 8px solid var(--serenity); box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .item-card.is-spend { border-left-color: var(--rose); }

        /* æŒ‘æˆ˜è¿›åº¦æ¡ä¸æç¤º */
        .daily-hint { background: linear-gradient(135deg, var(--rose), #ffdfdf); color: #6d4c41; padding: 18px; border-radius: 20px; margin-top: 15px; border: 1px solid #ffcfcf; }
        .progress-bg { background: #eee; height: 18px; border-radius: 10px; margin: 12px 0; overflow: hidden; border: 1px solid #ddd; }
        .progress-fill { background: linear-gradient(90deg, var(--serenity), var(--rose)); height: 100%; width: 0%; transition: 0.8s; }

        /* åº•éƒ¨å¯¼èˆª */
        .footer-nav { position: fixed; bottom: 0; width: 100%; height: 85px; background: white; display: flex; border-radius: 30px 30px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); }
        .nav-link { flex: 1; text-align: center; padding-top: 15px; color: #CFD8DC; font-size: 12px; }
        .nav-link.active { color: var(--serenity); font-weight: bold; }
        .nav-link i { font-size: 24px; display: block; margin-bottom: 4px; font-style: normal; }

        /* æ‚¬æµ®æ–°å¢æŒ‰é’® */
        .add-btn { position: fixed; bottom: 100px; right: 25px; width: 65px; height: 65px; background: linear-gradient(135deg, var(--serenity), var(--rose)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 35px; box-shadow: 0 8px 15px rgba(146,168,209,0.4); z-index: 500; }

        /* å¼¹çª—ä¸æ ‡ç­¾ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-con { position: absolute; bottom: 0; width: 100%; background: white; border-radius: 35px 35px 0 0; padding: 25px; max-height: 90vh; overflow-y: auto; }
        .tag-row { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .tag { padding: 8px 15px; background: #F5F7F9; border-radius: 12px; font-size: 13px; color: #78909C; }
        .tag.sel-s { background: var(--serenity) !important; color: white !important; }
        .tag.sel-p { background: var(--rose) !important; color: white !important; }

        input { width: 100%; padding: 14px; margin: 8px 0; border-radius: 15px; border: 1.5px solid #F0F0F0; background: #F9FBFF; font-size: 15px; outline: none; }
        .btn-action { width: 100%; padding: 16px; border: none; border-radius: 18px; font-weight: bold; color: white; font-size: 16px; margin-top: 10px; }
        .status-label { font-size: 10px; background: #E3F2FD; color: #1976D2; padding: 2px 8px; border-radius: 5px; margin-top: 4px; display: inline-block; }
    </style>
</head>
<body>

<div class="app-header">
    <h1>DK ç†è´¢æŒ‘æˆ˜ âš”ï¸ <span id="rate-display">1 RM = ... â‚©</span></h1>
</div>

<div class="content-container">
    <div id="p-chal" class="page">
        <div class="card-white" id="chal-setup">
            <h3 style="margin-top:0">ğŸ¯ å¼€å¯ä¸€å‘¨å­˜é’±æŒ‘æˆ˜</h3>
            <p style="font-size:13px; color:#999;">ç³»ç»Ÿå°†è‡ªåŠ¨ä»ä»Šå¤©èµ·ç®— 7 å¤©çš„å­˜é’±è®¡åˆ’</p>
            <small>æœ¬å‘¨ç›®æ ‡æ€»é¢ (RM)</small>
            <input type="number" id="target-amt" placeholder="ä¾‹å¦‚: 700">
            <button class="btn-action" style="background:var(--serenity)" onclick="startChal()">æŒ‘æˆ˜å¼€å§‹ âš”ï¸</button>
        </div>

        <div class="card-white" id="chal-active" style="display:none">
            <h3 style="margin:0">âš”ï¸ ä¸€å‘¨æŒ‘æˆ˜è¿›è¡Œä¸­</h3>
            <div id="chal-dates" style="font-size:12px; color:#999; margin:5px 0;"></div>
            
            <div class="progress-bg"><div id="progress-bar" class="progress-fill"></div></div>
            <center><b id="progress-text">0% (RM 0 / 0)</b></center>
            
            <div class="daily-hint">
                <center>
                    <small>è·ç¦»æœ¬å‘¨æŒ‘æˆ˜ç»“æŸè¿˜å‰© <span id="days-left">-</span> å¤©</small><br>
                    <span style="font-size:18px;">ä»Šæ—¥å»ºè®®å­˜å‚¨ï¼š<b id="daily-amt">RM 0.00</b></span>
                </center>
            </div>
            <button class="btn-action" style="background:#eee; color:#999; margin-top:20px;" onclick="cancelChal()">å–æ¶ˆæŒ‘æˆ˜</button>
        </div>
    </div>

    <div id="p-home" class="page" style="display:none">
        <h3 style="margin-left:5px;">ğŸŒ» å‚¨è“„ä¸æ”¯å‡ºå†å²</h3>
        <div id="list-render"></div>
    </div>

    <div id="p-set" class="page" style="display:none">
        <div class="card-white">
            <button class="btn-action" style="background:#81C784" onclick="doExport()">ğŸ“¤ å¯¼å‡º Excel å¤‡ä»½</button>
            <button class="btn-action" style="background:#B0BEC5; margin-top:15px;" onclick="document.getElementById('f-in').click()">ğŸ“¥ å¯¼å…¥æ•°æ®æ¢å¤</button>
            <input type="file" id="f-in" style="display:none" onchange="doImport(this)">
            <button class="btn-action" style="background:var(--rose); margin-top:40px;" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
        </div>
    </div>
</div>

<div class="add-btn" onclick="openAdd()">+</div>

<div class="footer-nav">
    <div class="nav-link active" onclick="navTo('chal', this)"><i>ğŸ†</i>æŒ‘æˆ˜</div>
    <div class="nav-link" onclick="navTo('home', this)"><i>ğŸŒ»</i>è®°å½•</div>
    <div class="nav-link" onclick="navTo('set', this)"><i>âš™ï¸</i>è®¾ç½®</div>
</div>

<div class="modal" id="modal-add">
    <div class="modal-con">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button id="ts" class="btn-action" style="background:var(--serenity); flex:1" onclick="setT('save')">å‚¨è“„</button>
            <button id="tp" class="btn-action" style="background:#eee; color:#999; flex:1" onclick="setT('spend')">æ”¯å‡º</button>
        </div>
        <input type="date" id="f-date">
        <small>è´¦æˆ·</small><div id="bx-acc" class="tag-row"></div>
        <small>åˆ†ç±»</small><div id="bx-tag" class="tag-row"></div>
        
        <div id="row-spend" style="display:none">
            <small>ç½‘è´­çŠ¶æ€</small><div id="bx-order" class="tag-row"></div>
            <small>è´­ä¹°æ¥æº</small><input type="text" id="f-source" placeholder="ä¾‹å¦‚: Weverse / æ·˜å®">
        </div>

        <small>é‡‘é¢ (RM)</small><input type="number" id="f-amt">
        <small>å¤‡æ³¨ / å•†å“å</small><input type="text" id="f-note">
        
        <button class="btn-action" style="background:var(--serenity)" onclick="saveRec()">ä¿å­˜è®°å½• ğŸ›¡ï¸</button>
        <button id="btn-del" class="btn-action" style="background:#EF5350; display:none" onclick="delRec()">ğŸ—‘ï¸ åˆ é™¤æ­¤è®°å½•</button>
        <center><button onclick="closeAdd()" style="border:none;background:none;color:#999;padding:15px;">å–æ¶ˆ</button></center>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('dk_v_locked_cn')) || { list: [], challenge: null };
    const CFG = {
        acc: ['RHB', 'HLB', 'TNG'],
        save: ['âš”ï¸ ç¡•ç‰å­˜é’±', 'ğŸ§§ æ„å¤–æ”¶å…¥', 'ğŸ’° å·¥èµ„'],
        spend: ['ğŸ’¿ ä¸“è¾‘', 'âœ¨ å°å¡', 'ğŸ­ éŸ³ä¹å‰§', 'ğŸ›ï¸ åŒæ¬¾', 'ğŸ“¦ é‚®è´¹', 'ğŸ± é¥­é’±'],
        order: ['âŒ æœªä»˜', 'âœ… å·²ä»˜', 'ğŸšš è¿é€ä¸­', 'ğŸ“¦ å·²æ”¶']
    };
    let curT = 'save', curTag = '', curAcc = 'RHB', curOrder = 'âœ… å·²ä»˜', editIdx = -1;

    function navTo(id, el) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById('p-' + id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(id === 'chal') updateChalUI();
        if(id === 'home') renderList();
    }

    // --- ä¸€å‘¨æŒ‘æˆ˜é€»è¾‘ (æ ¸å¿ƒ) ---
    function startChal() {
        const amt = parseFloat(document.getElementById('target-amt').value);
        if(!amt) return alert("è¯·è¾“å…¥æœ¬å‘¨å­˜é’±ç›®æ ‡é‡‘é¢ï¼");
        
        const start = new Date();
        const end = new Date();
        end.setDate(start.getDate() + 6); // è‡ªåŠ¨è®¡ç®—7å¤©

        db.challenge = { 
            target: amt, 
            start: start.toISOString().slice(0,10), 
            end: end.toISOString().slice(0,10) 
        };
        save(); updateChalUI();
    }

    function cancelChal() { if(confirm("ç¡®å®šå–æ¶ˆæœ¬å‘¨æŒ‘æˆ˜å—ï¼Ÿ")) { db.challenge = null; save(); updateChalUI(); } }
    
    function updateChalUI() {
        if(!db.challenge) {
            document.getElementById('chal-setup').style.display='block';
            document.getElementById('chal-active').style.display='none';
            return;
        }
        document.getElementById('chal-setup').style.display='none';
        document.getElementById('chal-active').style.display='block';
        
        const c = db.challenge;
        const today = new Date(); today.setHours(0,0,0,0);
        const endD = new Date(c.end);
        const diff = Math.ceil((endD - today) / (1000*60*60*24)) + 1;
        const daysLeft = Math.max(0, diff);
        
        const saved = db.list.filter(i => i.type === 'save' && i.date >= c.start && i.date <= c.end).reduce((a,b)=>a+b.amt, 0);
        const perc = Math.min((saved/c.target)*100, 100);
        
        document.getElementById('chal-dates').innerText = `å‘¨æœŸï¼š${c.start} è‡³ ${c.end}`;
        document.getElementById('progress-bar').style.width = perc + '%';
        document.getElementById('progress-text').innerText = `${perc.toFixed(1)}% (RM ${saved.toFixed(2)} / ${c.target})`;
        document.getElementById('days-left').innerText = daysLeft;
        
        // è‡ªåŠ¨è®¡ç®—ä»Šæ—¥å»ºè®®åº”å­˜é‡‘é¢
        const daily = (daysLeft > 0) ? (Math.max(c.target - saved, 0) / daysLeft) : 0;
        document.getElementById('daily-amt').innerText = `RM ${daily.toFixed(2)}`;
    }

    // --- è®°å½•ä¸åˆ—è¡¨é€»è¾‘ ---
    function setT(t) {
        curT = t;
        document.getElementById('ts').style.cssText = t==='save'?'background:var(--serenity);color:white;':'background:#eee;color:#999;';
        document.getElementById('tp').style.cssText = t==='spend'?'background:var(--rose);color:white;':'background:#eee;color:#999;';
        document.getElementById('row-spend').style.display = t==='spend'?'block':'none';
        renderTagsUI();
    }
    function renderTagsUI() {
        const cls = curT==='save'?'sel-s':'sel-p';
        document.getElementById('bx-acc').innerHTML = CFG.acc.map(a => `<div class="tag ${curAcc===a?cls:''}" onclick="curAcc='${a}';renderTagsUI()">${a}</div>`).join('');
        document.getElementById('bx-tag').innerHTML = CFG[curT].map(t => `<div class="tag ${curTag===t?cls:''}" onclick="curTag='${t}';renderTagsUI()">${t}</div>`).join('');
        if(curT==='spend') document.getElementById('bx-order').innerHTML = CFG.order.map(o => `<div class="tag ${curOrder===o?cls:''}" onclick="curOrder='${o}';renderTagsUI()">${o}</div>`).join('');
    }
    function openAdd() { editIdx = -1; document.getElementById('modal-add').style.display='block'; document.getElementById('btn-del').style.display='none'; document.getElementById('f-date').value=new Date().toISOString().slice(0,10); document.getElementById('f-amt').value=''; document.getElementById('f-note').value=''; curTag=''; setT('save'); }
    function openEdit(idx) {
        editIdx = idx; const i = db.list[idx];
        document.getElementById('modal-add').style.display='block';
        document.getElementById('btn-del').style.display='block';
        document.getElementById('f-date').value = i.date;
        document.getElementById('f-amt').value = i.amt;
        document.getElementById('f-note').value = i.note || '';
        document.getElementById('f-source').value = i.source || '';
        curT = i.type; curAcc = i.acc; curTag = i.tag; curOrder = i.order || 'âœ… å·²ä»˜';
        setT(curT);
    }
    function saveRec() {
        const amt = parseFloat(document.getElementById('f-amt').value);
        if(!amt || !curTag) return alert("è¯·å¡«å†™é‡‘é¢ä¸åˆ†ç±»ï¼");
        const data = { date: document.getElementById('f-date').value, amt, type: curT, tag: curTag, acc: curAcc, note: document.getElementById('f-note').value, order: curT==='spend'?curOrder:'', source: curT==='spend'?document.getElementById('f-source').value:'' };
        if(editIdx > -1) db.list[editIdx] = data; else db.list.unshift(data);
        save(); closeAdd(); renderList(); updateChalUI();
    }
    function delRec() { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { db.list.splice(editIdx,1); save(); closeAdd(); renderList(); updateChalUI(); } }
    function closeAdd() { document.getElementById('modal-add').style.display='none'; }
    function renderList() {
        document.getElementById('list-render').innerHTML = db.list.length === 0 ? '<center style="color:#ccc;margin-top:20px;">æš‚æ— å†å²è®°å½•</center>' : db.list.map((i, idx) => `
            <div class="item-card ${i.type==='spend'?'is-spend':''}" onclick="openEdit(${idx})">
                <div style="flex:1"><b>${i.tag}</b><br><small>${i.date} | ${i.acc}</small><br>
                ${i.order?`<span class="status-label">${i.order}</span>`:''} ${i.source?`<small style="color:#999">[${i.source}]</small>`:''}</div>
                <div style="text-align:right; color:${i.type==='save'?'var(--serenity)':'var(--rose)'}"><b>${i.type==='save'?'+':'-'} RM ${i.amt.toFixed(2)}</b></div>
            </div>`).join('');
    }

    // --- å·¥å…· ---
    function save() { localStorage.setItem('dk_v_locked_cn', JSON.stringify(db)); }
    function doExport() { const ws = XLSX.utils.json_to_sheet(db.list); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Records"); XLSX.writeFile(wb, "DK_Backup.xlsx"); }
    function doImport(f) { const r = new FileReader(); r.onload = (e) => { const d = new Uint8Array(e.target.result); const wb = XLSX.read(d, {type:'array'}); db.list = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); save(); location.reload(); }; r.readAsArrayBuffer(f.files[0]); }
    function clearAll() { if(confirm("è­¦å‘Šï¼šæ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼")) { localStorage.clear(); location.reload(); } }

    fetch('https://api.exchangerate-api.com/v4/latest/MYR').then(r=>r.json()).then(d=>document.getElementById('rate-display').innerText=`1 RM = ${d.rates.KRW.toFixed(0)} â‚©`);
    
    updateChalUI();
    renderList();
</script>
</body>
</html>
